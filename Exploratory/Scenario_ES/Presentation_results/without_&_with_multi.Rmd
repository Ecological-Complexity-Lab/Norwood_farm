---
title: "Potential general framework"
output:
  html_document:
    toc: yes
    toc_float: yes
    collapse: no
    number_sections: yes
    code_folding: hide
    theme: united
    highlight: tango
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "asis", message=FALSE, warning=FALSE, cache=TRUE, eval = TRUE, dev = c('png'), out.width = '100%', out.height='40%')
```

```{r load libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readr)
library(emln)#multilayer package
library(readr)
library(ggplot2)
library(cowplot)
rm(list=ls())
```



# Without multilayer approach
Pilot aggregating different habitats to create different management scenarios.

Here, we compared Ecosystem services provided by Extensive and Intensive habitat management.


```{r}
######################## LOAD DATA FILES #######################
edges <- tibble(read.csv("norwood_cleanest_edgelist.csv")) 

services <- tibble(read.csv("service_edgelist.csv")) %>% #Some nodes don't have ES
  rename (taxon = lower, ESS = upper) %>%
  pivot_wider(names_from = ESS, values_from = weight, values_fill = 0) %>%
  mutate(taxa_type = str_split(taxon, pattern = "[.]")[[2]][1]) #list of ecosystem (dis)services that each species provides

#### Ecosystem services provided by Extensive scenario

#Node list of Extensive scenario 
nodes_lower<-edges %>% select(habitat,lower)
nodes_upper<-edges %>% select(habitat,upper)
names(nodes_lower)<-names(nodes_upper)

nodes_extensive<-rbind(nodes_lower,nodes_upper) %>% group_by(habitat) %>% unique() %>% 
  rename("taxon"="upper")

#Create services list of Extensive scenario (considering every time a species appears in a habitat)

services_extensive <- services %>%  filter(taxon %in% c(nodes_extensive$taxon))

#joint dataframes
nodes_services_ext<- dplyr::right_join(nodes_extensive, services_extensive, by = "taxon") %>% select(-taxa_type)

#Degree of ecosystem provision

ES_habitat_ext<-nodes_services_ext %>% select(-habitat,-taxon) %>%  summarise(across(everything(), ~ sum(., na.rm = TRUE)))

ES_scenario_ext<-ES_habitat_ext %>% select(-habitat) %>%  summarise(across(everything(), ~ sum(., na.rm = TRUE)))



#### Ecosystem services provided by Intensive scenario

#Create edgelist of intensive scenario
edges_intensive<- edges %>%  filter(habitat == "CP" | habitat == "LP" |habitat == "LU" | 
                                      habitat == "NL" |habitat == "PP")

#Node list of intensive scenario 
nodes_lower<-edges_intensive %>% select(habitat,lower)
nodes_upper<-edges_intensive %>% select(habitat,upper)
names(nodes_lower)<-names(nodes_upper)

nodes_intensive<-rbind(nodes_lower,nodes_upper) %>% group_by(habitat) %>% unique() %>% 
  rename("taxon"="upper")

#Create services list of intensive scenario (considering every time a species appears in a habitat)

services_intensive <- services %>%  filter(taxon %in% c(nodes_intensive$taxon))

#joint dataframes
nodes_services_int<- dplyr::right_join(nodes_intensive, services_intensive, by = "taxon") %>% select(-taxa_type)

#Degree of ecosystem provision

ES_habitat_int<-nodes_services_int %>% select(-habitat,-taxon) %>%  summarise(across(everything(), ~ sum(., na.rm = TRUE)))

ES_scenario_int<-ES_habitat_int %>% select(-habitat) %>%  summarise(across(everything(), ~ sum(., na.rm = TRUE)))



## Box Plots comparing ecosystem services between Extensive and Intensive

ES_general<-rbind(ES_scenario_ext,ES_scenario_int)

Es_general<-cbind(Scenario =c("Ext","Int"), ES_general)

ES_general_final<-Es_general %>% gather("ES","state_node_providers",2:8)

ggplot(ES_general_final, aes(x = factor(ES), y = state_node_providers, fill = Scenario, colour = Scenario)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x="Ecosystem services (ES)", y="Number of species providing ES") +
  theme_bw() + 
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=11, color='black'),
        axis.text.x = element_text(size = 10, angle = 90),
        axis.title = element_text(size=13, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

```
\
\
\
\
\
\
\


# With multilayer approach {.tabset}

We built a multilayer network containing:

* Layers: Habitats

* Nodes: Species with attributes (attr: trophic groups and provided ecosystem services)

* Weighted intralayer links between trophic groups. Weight: product of the densities of species involved, scaled by the overall area covered by the habitat on the farm.


## Nodes per habitat
```{r}

# - Nodes per habitat (layer)
Norwood_farm<-readRDS("Norwood_farm.RData") #read multilayer object

state_nodes_attributes<-right_join(Norwood_farm$state_nodes,Norwood_farm$nodes, by = "node_name") %>% 
  select(-node_id.x,-node_id.y)#create state node list with attributes to use for explorating data

  Nodes_habitat<-Norwood_farm$state_nodes %>% 
  ggplot(aes(x=layer_name))+ geom_histogram(stat= "count", alpha= 0.70, color= "black")+ 
  labs(x='Habitat', y="Number of species") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))
  Nodes_habitat

```

## Nodes per habitat and trophic group

```{r}

Norwood_farm<-readRDS("Norwood_farm.RData") #read multilayer object

state_nodes_attributes<-right_join(Norwood_farm$state_nodes,Norwood_farm$nodes, by = "node_name") %>% 
  select(-node_id.x,-node_id.y)#create state node list with attributes to use for explorating data

nodes_hab_tax<- state_nodes_attributes %>%  select(layer_id,layer_name,node_name,taxon) %>% 
  group_by(layer_name) %>% count(taxon)
    
 nodes_habitat_taxon<- nodes_hab_tax %>%
   ggplot(aes(fill=taxon, y=n, x=layer_name)) + 
   geom_bar(position="stack", stat="identity")+
   labs(x='Habitat', y="Number of species") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=15, color='black'),
         axis.title = element_text(size=17, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_text(size = 13, color = "black"),
         legend.text = element_text(size = 11))
 
 nodes_habitat_taxon

```

## ES provided per taxon

```{r}

Norwood_farm<-readRDS("Norwood_farm.RData") #read multilayer object

state_nodes_attributes<-right_join(Norwood_farm$state_nodes,Norwood_farm$nodes, by = "node_name") %>% 
  select(-node_id.x,-node_id.y)#create state node list with attributes to use for explorating data

ES_taxon<- state_nodes_attributes %>%  group_by(taxon) %>% distinct(node_name, .keep_all = TRUE) %>% select(node_name,taxon,ES,DES) %>% 
   gather(key = "provision", value= "value", 3:4) %>% group_by(taxon,provision) %>% 
   summarise(values = sum(value))
   
 Nodes_ES<-ES_taxon %>% 
   ggplot(aes(y=values, x=taxon, fill = provision)) + 
   geom_bar(position="stack", stat="identity")+
   labs(x='Taxon', y="Number of services") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=15, color='black'),
         axis.text.x= element_text(size =13, angle = 90), 
         axis.title = element_text(size=17, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_text(size = 13, color = "black"),
         legend.text = element_text(size = 11))
 
 Nodes_ES

```

## ES per habitat

```{r}

Norwood_farm<-readRDS("Norwood_farm.RData") #read multilayer object

state_nodes_attributes<-right_join(Norwood_farm$state_nodes,Norwood_farm$nodes, by = "node_name") %>% 
  select(-node_id.x,-node_id.y)#create state node list with attributes to use for explorating data

ES_habitat <-   state_nodes_attributes %>%  group_by(layer_name, node_name) %>% select(-taxon) %>% gather(key = "provision", value= "value", 4:10) %>% group_by(layer_name,provision) %>% 
  summarise(values = sum(value))
  
Habitat_ES<-ES_habitat %>% 
  ggplot(aes(y=values, x=layer_name, fill = provision)) + 
  geom_bar(position="stack", stat="identity")+
  labs(x='Habitat', y=" (Dis)services provided") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

  Habitat_ES

```

## Link's distribution

```{r}

 ecological_links <- read.csv("species_edgelist.csv")
  species_links <- ecological_links %>% 
    group_by(lower, upper) %>% 
    summarise(weight = sum(weight))
  
  # Group links according to the trophic groups (not specified + or - int for birds )
  trophic<- species_links %>% 
    separate(lower, c("trophic_lower", "lower"),  "[A-Z]\\.[A-Z]") %>%
    separate(upper, c("trophic_upper", "upper"),  "[A-Z]\\.[A-Z]")#separate information
  
  trophic2<-trophic %>%
    mutate(trophic_upper = recode(trophic_upper, '01PLAN' = 'Plant',
                                  "02F" = "Flower visitor",
                                  "03AP" = "Aphidos", "04PRIMARYPAR" = "Par. 1",
                                  "05SECONDARYPAR" = "Par. 2","06MINERPAR" = "Leaf min.","07SEEDINVER" = "Seed pred (Inv)", "08BIR" = "Bird", "09MAMMA" = "Seed pred (Mam)", "12BFL" = "Butterfly", "13SFPAR" = "Par. (Syrph)", "14FLE" = "Flea"),
           
           trophic_lower = recode(trophic_lower, '01PLAN' = 'Plant', 
                                  "01PLANT.zCROP Barley" = "Plant", "01PLANT.zCROP Lucerne" = "Plant", "01PLANT.zCROP Oat spring" = "Plant", "01PLANT.zCROP Oat winter" = "Plant", "01PLANT.zCROP Triticale" = "Plant", "01PLANT.zCROP Wheat" = "Plant",
                                  "02F" = "Flower visitor",
                                  "03AP" = "Aphidos", "04PRIMARYPAR" = "Par. 1",
                                  "05SECONDARYPAR" = "Par. 2","06MINERPAR" = "Leaf min.","07SEEDINVER" = "Seed pred (Inv)", "08BIR" = "Bird", "09MAMMA" = "Seed pred (Mam)", "12BFL" = "Butterfly", "13SFPAR" = "Par. (Syrph)", "14FLE" = "Flea"))
  
  
  #Merge trophic groups to create interaction dataframe
  trophic2$Int <- paste(trophic2$trophic_lower, trophic2$trophic_upper, sep= "-")
  
  Int_trophic<-trophic2 %>% select(Int,weight)
  Int_trophic$Int<-as.character(Int_trophic$Int)
  
  #Plot trophic interactions distribution
  
  Int_trophic %>%
    ggplot(aes(x=weight, fill=Int))+ geom_histogram(position= "identity", alpha= 0.70, color= "black")+ 
    labs(x='Weight', y="Count") +theme_bw()+
    theme_classic()+ 
    theme(panel.grid = element_blank(),
          panel.border = element_rect(color = "black",fill = NA,size = 1),
          panel.spacing = unit(0.5, "cm", data = NULL),
          axis.text = element_text(size=10, color='black'),
          axis.title = element_text(size=17, color='black'),
          axis.line = element_blank(),
          legend.text.align = 0,
          legend.title =  element_text(size = 13, color = "black"),
          legend.text = element_text(size = 11))

```
 
## Distribution of modules across habitats

```{r}

mod<-read.csv("Norwood_modules.csv") #read module output

#arrange data to include modules sizes
size <- count(mod, module)  #create a data frame of all modules and how many nodes are in each (size of module)
module_data <- merge(mod , size, by=c("module","module")) #merge size of module with all the other info about the modules
colnames(module_data)[16] <- "size_of_module" #rename column

#how many layers are within a module
module_data <- module_data %>% select(layer_id, module, size_of_module) %>% unique() #take only certain columns
module_data$count <- c(1)

mod_hab <- module_data %>% 
  mutate(layer_name= case_when(layer_id == '1' ~ 'CP',
                               layer_id == '2' ~ 'GM',
                               layer_id == '3' ~ 'LP',
                               layer_id == '4' ~ 'LU',
                               layer_id == '5' ~ 'MH',
                               layer_id == '6' ~ 'NH',
                               layer_id == '7' ~ 'NL',
                               layer_id == '8' ~ 'PP',
                               layer_id == '9' ~ 'RG',
                               layer_id == '10' ~ 'SF',
                               layer_id == '11' ~ 'WD',
                               ))

mod_hab <- mod_hab %>% unique()  %>% group_by(module) %>%  
  mutate(tot_hab = sum (count)) %>% arrange(desc(tot_hab))

mod_hab$module<- as.factor(mod_hab$module)

mod_hab %>% 
  ggplot(aes(x=module, y= count ,fill= factor(layer_name)))+ geom_bar(stat= "identity")+ theme_classic()+ labs(y="Number of habitats", x="Modules")+
  guides(fill=guide_legend(title="Habitat"))+ theme(axis.text.x = element_blank(),
                                                     axis.text.y=element_text(size=15), axis.title = element_text(size=17),
                                                     legend.text=element_text(size=12.5),legend.title =element_text(size=14))

```

## Modules' size

```{r}

mod<-read.csv("Norwood_modules.csv") #read module output


 #arrange data to include modules sizes
size <- count(mod, module)  #create a data frame of all modules and how many nodes are in each (size of module)
module_data <- merge(mod , size, by=c("module","module")) #merge size of module with all the other info about the modules
colnames(module_data)[16] <- "size_of_module" #rename column


# - Modules' size

#how many layers are within a module
module_data <- module_data %>% select(layer_id, module, size_of_module) %>% unique() #take only certain columns
module_data$count <- c(1)

module_data %>% 
  ggplot(aes(x=module, y= size_of_module))+ geom_bar(stat= "identity")+ theme_classic()+ labs(y="Size", x="Modules")+
 theme(axis.text.x = element_blank(),
                                         axis.text.y=element_text(size=15), axis.title = element_text(size=17),
                                          legend.text=element_text(size=12.5),legend.title =element_text(size=14))

```
 
## Modules'composion (trophic group)

```{r}

mod<-read.csv("Norwood_modules.csv") #read module output


 # - Modules'composion (trophic group)

mod_trophic <- mod %>%  left_join(size,mod,by = "module") %>% group_by(module, taxon) %>% 
  summarise(taxon_count = n(), taxon_prop = taxon_count/n) %>% unique()

mod_trophic %>% 
  ggplot(aes(x=module, y= taxon_prop, fill= factor(taxon)))+ geom_bar(stat= "identity", width = 0.9)+ theme_classic()+ labs(y="Prop of trophic/module", x="Modules")+
  guides(fill=guide_legend(title="Taxon"))+ theme(axis.text.x = element_blank(),
                                                    axis.text.y=element_text(size=15), axis.title = element_text(size=17),
                                                    legend.text=element_text(size=12.5),legend.title =element_text(size=14))


```

## Modules'composion (ES)

```{r}

mod<-read.csv("Norwood_modules.csv") #read module output

Norwood_farm<-readRDS("Norwood_farm.RData") #read multilayer object

state_nodes_attributes<-right_join(Norwood_farm$state_nodes,Norwood_farm$nodes, by = "node_name") %>% 
  select(-node_id.x,-node_id.y)#create state node list with attributes to use for explorating data

 ES_taxon<- state_nodes_attributes %>%  group_by(taxon) %>% distinct(node_name, .keep_all = TRUE) %>% select(node_name,taxon,ES,DES) %>% 
  gather(key = "provision", value= "value", 3:4) %>% group_by(taxon,provision) %>% 
  summarise(values = sum(value))

mod_es <- mod %>%  gather(key = "provision", value= "value", 8:13) %>% group_by(module, provision) %>% 
  summarise(es_count = sum(value)) 
  
  

mod_es %>% 
  ggplot(aes(x=module, y= es_count, fill= factor(provision)))+ geom_bar(stat= "identity", width = 0.9)+ theme_classic()+ labs(y="Number of (Dis)services", x="Modules")+
  guides(fill=guide_legend(title="Type of ES"))+ theme(axis.text.x = element_blank(),
                                                  axis.text.y=element_text(size=15), axis.title = element_text(size=17),
                                                  legend.text=element_text(size=12.5),legend.title =element_text(size=14))


```

\
\
\
\
\
\
\

# Direct and indirect effects of ES {.tabset}

We calculated the direct ES provide by each species and its indirect effect on other ESs

## Number and prop ES/hab

```{r}

 ## Direct and indirect ES provided in each habitat and in total
Final_ES <- read.csv("Final_ES.csv", sep =",")

##Number 

#1 hop
Hab_ES<-Final_ES %>% group_by(layer, type) %>% filter( hop == 0 | hop == 1,
                                                       services_to != "None") %>%
  summarize(count = n())


Hab_ES_1<-Hab_ES%>% 
  ggplot(aes(y=count, x=layer, fill =type)) + 
  geom_bar(position="dodge", stat="identity")+
  labs(x='Habitat', y="Number of ES provided") +theme_bw()+ggtitle("1 hop")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")

#2 hop
Hab_ES_2<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None") %>%
  summarize(count = n())


Hab_ES_2<-Hab_ES_2%>% 
  ggplot(aes(y=count, x=layer, fill =type)) + 
  geom_bar(position="dodge", stat="identity")+
  labs(x='Habitat', y="Number of ES provided") +theme_bw()+
  ggtitle("2 hops")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")

upper_row<- plot_grid(Hab_ES_1 ,
                      Hab_ES_2 , 
                      ncol = 2)
upper_row


```

\
\
\

```{r}

 ## Direct and indirect ES provided in each habitat and aggregated
Final_ES <- read.csv("Final_ES.csv", sep =",")

## Proportion

#1 hop
Hab_ES_prop<-Final_ES %>% group_by(layer, type) %>% filter( hop == 0 | hop == 1,
                                                       services_to != "None") %>%
  summarize(count= n()) %>% group_by(layer) %>% mutate(tot =sum(count)) %>% 
  group_by(layer,type) %>% summarize(prop = count/tot)


Hab_ES_1<-Hab_ES_prop%>% 
  ggplot(aes(y=prop, x=layer, fill =type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("1 hop")+
  labs(x='Habitat', y="Prop ES provided") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")

 
#2 hops
Hab_ES_prop_2<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None") %>%
  summarize(count= n()) %>% group_by(layer) %>% mutate(tot =sum(count)) %>% 
  group_by(layer,type) %>% summarize(prop = count/tot)


Hab_ES_2<-Hab_ES_prop_2 %>% 
  ggplot(aes(y=prop, x=layer, fill =type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("2 hops")+
  labs(x='Habitat', y="Prop ES provided") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")
 

upper_row<- plot_grid(Hab_ES_1 ,
                      Hab_ES_2 , 
                      ncol = 2)
upper_row
```

## Prop. ES per taxon/habitat

```{r}

## Prop of direct and Indirect ES provided per taxon /habitat 
Final_ES <- read.csv("Final_ES.csv", sep =",")

# 1 hop
 
 taxon_ES_1<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None", hop == 0 | hop ==1) %>% 
   mutate(Total = n()) %>% group_by(layer,type, taxon) %>% 
   summarize( Number = n(), Prop = Number /Total) %>% unique()
 
 
 taxon_tot_1<- Final_ES %>% group_by(type) %>% filter(services_to != "None",  hop == 0 |hop == 1) %>% 
   mutate(Total = n()) %>% group_by(type, taxon) %>% 
   summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
 taxon_tot_1<-taxon_tot_1[,c(3,1,2,4,5)]
 
 taxon_ES_1<-rbind(taxon_tot_1,taxon_ES_1)
 
 #Direct
 D_taxon_ES_1<-taxon_ES_1 %>% filter(type == "D") %>% 
   ggplot(aes(y=Prop, x=layer, fill = taxon)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Direct ES - 1 hop")+
   labs(x='Habitat', y="Prop ES provided per taxon") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90), 
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom",
         legend.key.size = unit(0.5,"line"))
 
 
 #Indirect
 I_taxon_ES_1<-taxon_ES_1 %>% filter(type == "I") %>% 
   ggplot(aes(y=Prop, x=layer, fill = taxon)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Indirect ES - 1 hop")+
   labs(x='Habitat', y="Prop ES provided per taxon") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90),
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom",
         legend.key.size = unit(0.5,"line"))
 

 
 upper_row<- plot_grid(D_taxon_ES_1 ,
                      I_taxon_ES_1 , 
                      ncol = 2)
upper_row
 
```

\
\
\

```{r}

## Prop of direct and Indirect ES provided per taxon /habitat 
Final_ES <- read.csv("Final_ES.csv", sep =",")

# 2 hop
 
 taxon_ES<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None") %>% 
   mutate(Total = n()) %>% group_by(layer,type, taxon) %>% 
   summarize( Number = n(), Prop = Number /Total) %>% unique()
 

 taxon_tot<- Final_ES %>% group_by(type) %>% filter(services_to != "None") %>% 
   mutate(Total = n()) %>% group_by(type, taxon) %>% 
   summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
 taxon_tot<-taxon_tot[,c(3,1,2,4,5)]

 taxon_ES<-rbind(taxon_tot,taxon_ES)
 
 #Direct
 D_taxon_ES<-taxon_ES %>% filter(type == "D") %>% 
   ggplot(aes(y=Prop, x=layer, fill = taxon)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Direct ES - 2 hops")+
   labs(x='Habitat', y="Prop ES provided per taxon") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
          axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90), 
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom",
         legend.key.size = unit(0.5,"line"))
 
 
 #Indirect
 I_taxon_ES<-taxon_ES %>% filter(type == "I") %>% 
   ggplot(aes(y=Prop, x=layer, fill = taxon)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Indirect ES - 2 hops")+
   labs(x='Habitat', y="Prop ES provided per taxon") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
           axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90),
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom",
         legend.key.size = unit(0.5,"line"))
 

 
 upper_row<- plot_grid(D_taxon_ES ,
                      I_taxon_ES , 
                      ncol = 2)
upper_row
 
 
```

## Prop. ES provided per services /habitat 

```{r}

## Prop of direct and Indirect ES provided per taxon /habitat 
Final_ES <- read.csv("Final_ES.csv", sep =",")

# 1 hop
 
services_ES_1<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None" , hop == 0 | hop == 1) %>% 
   mutate(Total = n()) %>% group_by(layer,type, services) %>% 
   summarize( Number = n(), Prop = Number /Total) %>% unique()
 
 
 services_tot_1<- Final_ES %>% group_by(type) %>% filter(services_to != "None", hop == 0 | hop == 1) %>% 
   mutate(Total = n()) %>% group_by(type, services) %>% 
   summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
 services_tot_1<-services_tot_1[,c(3,1,2,4,5)]
 
 services_tot_ES_1<-rbind(services_tot_1,services_ES_1)
 
 #Direct
 D_services_ES_1<-services_tot_ES_1 %>% filter(type == "D") %>% 
   ggplot(aes(y=Prop, x=layer, fill = services)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Direct ES - 1 hop")+
   labs(x='Habitat', y="Prop of ES provided per type") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
          axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90),
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom")
 
 
 
 #Indirect
 I_services_ES_1<-services_tot_ES_1 %>% filter(type == "I") %>% 
   ggplot(aes(y=Prop, x=layer, fill = services)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Indirect ES - 1 hop")+
   labs(x='Habitat', y="Prop of ES provided per type") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90),
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom")
 
 
 
 upper_row<- plot_grid(D_services_ES_1 ,
                      I_services_ES_1 , 
                      ncol = 2)
upper_row
 
```

\
\
\

```{r}

## Prop of direct and Indirect ES provided per taxon /habitat 
Final_ES <- read.csv("Final_ES.csv", sep =",")

# 2 hop
 
services_ES<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None") %>% 
   mutate(Total = n()) %>% group_by(layer,type, services) %>% 
   summarize( Number = n(), Prop = Number /Total) %>% unique()
 
 
 services_tot<- Final_ES %>% group_by(type) %>% filter(services_to != "None") %>% 
   mutate(Total = n()) %>% group_by(type, services) %>% 
   summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
 services_tot<-services_tot[,c(3,1,2,4,5)]
 
 services_tot_ES<-rbind(services_tot,services_ES)
 
 #Direct
 D_services_ES<-services_tot_ES %>% filter(type == "D") %>% 
   ggplot(aes(y=Prop, x=layer, fill = services)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Direct ES- 2 hops")+
   labs(x='Habitat', y="Prop of ES provided per type") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
          axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90),
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom")
 
 
 
 #Indirect
 I_services_ES<-services_tot_ES %>% filter(type == "I") %>% 
   ggplot(aes(y=Prop, x=layer, fill = services)) + 
   geom_bar(position="stack", stat="identity")+ ggtitle("Indirect ES - 2 hops")+
   labs(x='Habitat', y="Prop of ES provided per type") +theme_bw()+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=13, color='black'),
         axis.text.x= element_text(size =11, angle = 90), 
         axis.text.y= element_text(size =11, angle = 90),
         axis.title = element_text(size=15, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_blank(),
         legend.text = element_text(size = 4),
         legend.position = "bottom")
 

 
 upper_row<- plot_grid(D_services_ES ,
                      I_services_ES , 
                      ncol = 2)
upper_row
 
```

## Sps importance

```{r}

## Prop of direct and Indirect ES provided per taxon /habitat 
Final_ES <- read.csv("Final_ES.csv", sep =",")

# 1 hop

sps_imp_1<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None" , hop == 0 | hop ==1) %>% 
   mutate(Total = n()) %>% group_by(layer,type, node_id) %>% 
   summarize( Number = n(), Prop = Number /Total) %>% unique()
 
 
 sps_imp_tot_1<- Final_ES %>% group_by(type) %>% filter(services_to != "None", hop == 0 | hop== 1) %>% 
   mutate(Total = n()) %>% group_by(type, node_id) %>% 
   summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
 sps_imp_tot_1<-sps_imp_tot_1[,c(3,1,2,4,5)]
 
 sps_imp_tot_ES_1<-rbind(sps_imp_tot_1,sps_imp_1) %>% group_by(layer,node_id) %>% 
   summarize(Tot = sum(Number)) #considering both direct and indirect
 
 
 
 #Just Total (without considering habitats)
 sps_imp_number_1<- sps_imp_tot_ES_1 %>% filter(layer == "Tot") %>%
   ggplot(aes(y=Tot, x= node_id)) + geom_bar(stat="identity")+
   labs(x='Node_id', y="Number of ES provided") +theme_bw()+ ggtitle("1 hop")+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=15, color='black'),
         axis.text.x= element_text(size =10, angle = 90), 
         axis.title = element_text(size=11, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_text(size = 13, color = "black"),
         legend.text = element_text(size = 11))
 
 

# 2 hops
sps_imp<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None") %>% 
  mutate(Total = n()) %>% group_by(layer,type, node_id) %>% 
  summarize( Number = n(), Prop = Number /Total) %>% unique()


sps_imp_tot<- Final_ES %>% group_by(type) %>% filter(services_to != "None") %>% 
  mutate(Total = n()) %>% group_by(type, node_id) %>% 
  summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
sps_imp_tot<-sps_imp_tot[,c(3,1,2,4,5)]

sps_imp_tot_ES<-rbind(sps_imp_tot,sps_imp) %>% group_by(layer,node_id) %>% 
  summarize(Tot = sum(Number)) #considering both direct and indirect

 

#Just Total (without considering habitats)
 sps_imp_number<- sps_imp_tot_ES %>% filter(layer == "Tot") %>%
   ggplot(aes(y=Tot, x= node_id)) + geom_bar(stat="identity")+
   labs(x='Node_id', y="Number of ES provided") +theme_bw()+ ggtitle ("2 hops")+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=15, color='black'),
         axis.text.x= element_text(size =10, angle = 90), 
         axis.title = element_text(size=11, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_text(size = 13, color = "black"),
         legend.text = element_text(size = 11))
 

 upper_row<- plot_grid(sps_imp_number_1 ,
                      sps_imp_number , 
                      nrow = 2)
upper_row
 
 
```

\
\
\

```{r}

## See the most four important species across habitats

Final_ES <- read.csv("Final_ES.csv", sep =",")

# 1 hop
 sps_imp_1<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None" , hop == 0 | hop ==1) %>% 
   mutate(Total = n()) %>% group_by(layer,type, node_id) %>% 
   summarize( Number = n(), Prop = Number /Total) %>% unique()
 
 
 sps_imp_tot_1<- Final_ES %>% group_by(type) %>% filter(services_to != "None", hop == 0 | hop== 1) %>% 
   mutate(Total = n()) %>% group_by(type, node_id) %>% 
   summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
 sps_imp_tot_1<-sps_imp_tot_1[,c(3,1,2,4,5)]
 
 sps_imp_tot_ES_1<-rbind(sps_imp_tot_1,sps_imp_1) %>% group_by(layer,node_id) %>% 
   summarize(Tot = sum(Number)) #considering both direct and indirect
 
  #chose the four species that provide ecosystem services the most
 
 four_sp_1<-sps_imp_tot_ES_1 %>% filter(layer == "Tot") %>% 
   arrange(desc(Tot)) %>% head(n = 4)
 
 four_sp_birds_1<-sps_imp_tot_ES_1 %>% filter(layer != "Tot", node_id == 41 | node_id == 24 |
                                            node_id == 26 | node_id ==13) 
 four_sp_birds_1$node_id<-as.character(four_sp_birds_1$node_id)
 
 #Most important nodes across habitat
 
 imp_sps_ES_1<- four_sp_birds_1 %>%
   ggplot(aes(y=Tot, x= node_id, fill = layer)) + geom_bar(position="dodge", stat="identity")+
   labs(x='Node_id', y="Number of ES provided") +theme_bw()+ ggtitle("1 hop")+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=15, color='black'),
         axis.text.x= element_text(size =13, angle = 90), 
         axis.title = element_text(size=17, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_text(size = 13, color = "black"),
         legend.text = element_text(size = 11))
 
 
 # 2 hops
 
sps_imp<-Final_ES %>% group_by(layer, type) %>% filter(services_to != "None") %>% 
  mutate(Total = n()) %>% group_by(layer,type, node_id) %>% 
  summarize( Number = n(), Prop = Number /Total) %>% unique()


sps_imp_tot<- Final_ES %>% group_by(type) %>% filter(services_to != "None") %>% 
  mutate(Total = n()) %>% group_by(type, node_id) %>% 
  summarize( layer= "Tot",Number = n(), Prop = Number /Total) %>% unique()
sps_imp_tot<-sps_imp_tot[,c(3,1,2,4,5)]

sps_imp_tot_ES<-rbind(sps_imp_tot,sps_imp) %>% group_by(layer,node_id) %>% 
  summarize(Tot = sum(Number)) #considering both direct and indirect

#chose the four species that provide ecosystem services the most
 
 four_sp<-sps_imp_tot_ES %>% filter(layer == "Tot") %>% 
   arrange(desc(Tot)) %>% head(n = 4)
 
 four_sp_birds<-sps_imp_tot_ES %>% filter(layer != "Tot", node_id == 495 | node_id == 496 |
                                          node_id == 497 | node_id ==502) 
 four_sp_birds$node_id<-as.character(four_sp_birds$node_id)
 
 #Most important nodes across habitat
 
 imp_sps_ES<- four_sp_birds %>%
   ggplot(aes(y=Tot, x= node_id, fill = layer)) + geom_bar(position="dodge", stat="identity")+
   labs(x='Node_id', y="Number of ES provided") +theme_bw()+ggtitle("2 hops")+
   theme_classic()+
   theme(panel.grid = element_blank(),
         panel.border = element_rect(color = "black",fill = NA,size = 1),
         panel.spacing = unit(0.5, "cm", data = NULL),
         axis.text = element_text(size=15, color='black'),
         axis.text.x= element_text(size =13, angle = 90), 
         axis.title = element_text(size=17, color='black'),
         axis.line = element_blank(),
         legend.text.align = 0,
         legend.title =  element_text(size = 13, color = "black"),
         legend.text = element_text(size = 11))
 
 
 upper_row<- plot_grid(imp_sps_ES_1 ,
                      imp_sps_ES , 
                      ncol = 2)
upper_row
 
 
```

\
\
\

\
\
\




# Next steps...

\

* Effects of nodes on ESs (direct and indirect) instead of ES-ES
\
\

* Ask Shai how attributes work (explain modularity).

\
\

* When we calculate the quantity of ES provided we can include abundance (as attributes of state nodes) and size of the species (e.g., small, medium, big as attributes of nodes). This would help to control for taxon groups with great abundance such as insects. It could be the product between abundance and size (small = 0.1, medium = 0.5, big =1).

\
\

* Intraedges between 0 and 1. Let's suppose we have an aphid species A and a plant species B in a specific habitat. The weight of A-B will be equal to: the product of their abundances / product of abundances of between all aphid and plant species in the specific habitat. Abundance instead of density. RELATIVE ABUNDANCES

\
\

* Interedges? 

\
\

* Extinction scenarios: Which kind of approach we want to use? create different multilayer according to the habitat management or simulate the change in habitat management with the extinction models?

\
\

* Igraph guide

\
\



TO DO:

* Change graphs to proportion 


DUDA: Multilayer:

* 2 layers: phy - spi & spi - bird

* Intralayer links: weighted predation interaction

* Interlayer links: indirect interaction between species (for example, from bird to phy)

Is it necessary to link spiders between layers? otherwise, modules will jump from phy to birds. In the case it is necessary, can interlayer liks represent different things? put the meaning in link's attributes
