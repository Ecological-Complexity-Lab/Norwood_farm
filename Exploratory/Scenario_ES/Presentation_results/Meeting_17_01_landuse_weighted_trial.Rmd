---
title: "Land use change weighted trial"
output:
  html_document:
    toc: yes
    toc_float: yes
    collapse: no
    number_sections: yes
    code_folding: hide
    theme: united
    highlight: tango
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "asis", message=FALSE, warning=FALSE, cache=TRUE, eval = TRUE, dev = c('png'), out.width = '100%', out.height='40%')

```

```{css}
/* Custom CSS to reduce TOC font size */
#TOC {
  font-size: 0.8em; /* Adjust the value to your preference */
}
```

```{r load libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readr)
library(emln) #multilayer package
library(readr)
library(readxl)
library(ggplot2)
library(cowplot)
library(paletteer)
rm(list=ls())
```

\
\
\



# Land use change simulation - Binary
\

<font size="4">
**1)** Create multilayer network with habitats as layers.
\
\

**2)** Replace the specific habitats to "CP" (including all species, assuming that community reached the equilibrium).
\
\

**3)** Aggregate the habitats to create the Norwoodfarm network. During this step, We did two different scenarios: removed duplicated links (equivalent to habitat loss) and we keep duplicated links (equivalent to sum habitats).


\
\
\
\


# Land use change simulation - Weighted
\
<font size="4">

**1)** Create multilayer network with abundances as state nodes attributes (nodes' abundances per each habitat)
\
\

**2)** Replace the habitats to "CP" but modifying the abundance of each species according to the area.
\
\

**3)** Aggregate the habitats to create the Norwoodfarm network. During this step, we add the abundances of the same species across habitats. Then, we calculate the weight of links between two species:

$w_{ji}=Ar_{j}\times Ar_{i}$
\

where $Ar_j$ and $Ar_i$ represent the relative abundance of species $j$ and $i$ in their trophic group.


\
\
\
\
\

## Direct provision E(D)S {.tabset}
\

We estimated the direct provision of E(D)S by species in each habitat management.
\

The direct provision of E(D)S by species $i$ ($E_i$) will be equal to:
\
\

$E_i= A_i$, where $A_i$ is the abundance of the species $i$. 
\
\

However, for those E(D)S provided by different trophic groups, we multiplied the abundance for a constant related to the body size.
\

### Number of direct E(D)S provision
\


```{r}

#Number of EDS provision no removal

direct_ES <- read.csv("Land_use_dir_weighted_trial_norem.csv", sep =",") 

Number<-direct_ES %>% group_by(management) %>% summarize(Number = n())

Number$management <- factor(Number$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

Number<-Number%>%   
  ggplot(aes(y=Number, x=management)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("no removal")+
  labs(x='Management', y="Number of direct E(D)S provision") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank())



#Number of EDS provision removal

direct_ES_rem <- read.csv("Land_use_dir_weighted_trial_removal.csv", sep =",") #ratio ES

Number_rem<-direct_ES_rem %>% group_by(management) %>% summarize(Number = n())

Number_rem$management <- factor(Number_rem$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors


Number_rem<-Number_rem%>%   
  ggplot(aes(y=Number, x=management)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("removal")+
  labs(x='Management', y="Number of direct E(D)S provision") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank())

upper_row<- plot_grid(Number,Number_rem ,
                  ncol = 2)
upper_row

```
\
\
\
\

### ES/E(D)S
\
```{r}

ratio_direct <- read.csv("Land_use_rat_dir_weighted_trial_norem.csv", sep =",") #ratio ES

ratio_direct$management <- factor(ratio_direct$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

ratio_direct<-ratio_direct%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("Ratio direct ES/EDS - no removal")+
  labs(x='Manegement', y="Prop of E(D)S") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
          legend.position = "bottom")

ratio_direct_rem <- read.csv("Land_use_rat_dir_weighted_trial_removal.csv", sep =",") #ratio ES

ratio_direct_rem$management <- factor(ratio_direct_rem$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

ratio_direct_rem<-ratio_direct_rem%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("Ratio direct ES/EDS - removal")+
  labs(x='Manegement', y="Prop of E(D)S") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")


upper_row<- plot_grid(ratio_direct,ratio_direct_rem ,
                  ncol = 2)
upper_row

```
\
\
\
\

### Weighted direct provision 

```{r}

# Weight of direct ES provision according to output (no removal)

direct_ES <- read.csv("Land_use_dir_weighted_trial_norem.csv", sep =",") #ratio ES

weights_management<-direct_ES %>% group_by(management, output) %>% 
  summarise(weight_mean = mean(weight),
            weight_sd = sd(weight),
            weight_se =  sd(weight) / sqrt(n()))#calculate avergae nad standart error

weights_management$management <- factor(weights_management$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

#barplot
weights_output_mangement_dir<-weights_management %>% 
  ggplot(aes(y=weight_mean, x=management, fill =output)) + 
  geom_errorbar(
    aes(ymin =0 , ymax = weight_mean + weight_se),
    position = position_dodge(width = 0.9),
    width = 0.25
  ) +
  geom_bar(position="dodge", stat="identity")+
  labs(x='Management', y="Weight direct E(D)S provision") +theme_bw()+ ggtitle("no removal")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")

# Weight of direct ES provision according to output (removal)

direct_ES_rem <- read.csv("Land_use_dir_weighted_trial_removal.csv", sep =",") #ratio ES

weights_management_rem<-direct_ES_rem %>% group_by(management, output) %>% 
  summarise(weight_mean = mean(weight),
            weight_sd = sd(weight),
            weight_se =  sd(weight) / sqrt(n()))#calculate avergae nad standart error

weights_management_rem$management <- factor(weights_management_rem$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

#barplot
weights_output_mangement_dir_rem<-weights_management_rem %>% 
  ggplot(aes(y=weight_mean, x=management, fill =output)) + 
  geom_errorbar(
    aes(ymin =0 , ymax = weight_mean + weight_se),
    position = position_dodge(width = 0.9),
    width = 0.25
  ) + 
  geom_bar(position="dodge", stat="identity")+  ggtitle("removal")+
  labs(x='Management', y="Weight direct E(D)S provision") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")
upper_row<- plot_grid(weights_output_mangement_dir,weights_output_mangement_dir_rem ,
                  ncol = 2)
upper_row

```

\
\
\
\

## Indirect effects on E(D)S provision {.tabset}
\

We detected indirect effects of a target species on ecosystem services based on its neighbors. We calculated first and second order indirect interactions for each species.
\
\

### Detection of indirect effects 
\
\

#### **First order indirect effects (1 hop)**

![](1_hop.png)

**Node A:**

Direct provision: Crop production

Indirect effect on: Crop damage

\
\


#### **Second-order indirect effects (2 hops)**
\
\

![](2_hop.png)


**Node A:**

Direct provision: Crop production

Indirect effect on: Crop damage 

Indirect effect on: Pest control

\
\
\
\
\
\


### Output
\

For each interaction, we assigned the following outputs:
\

<font size="5"> **+** : </font> increases ES provision or decreases crop damage.
\

<font size="5"> **-** : </font> decreases ES provision or increases crop damage

\
\
\
\
\
\

### Weight
\

<font size="4">**First order indirect effects**
\

The weight of the indirect effect of species $i$ on E(D)S provided by species $j$ ($S_{ij}$) will be equal to:
\
\

$S_{ij}$ = $w_{ij}$
\
\

where $w_{ij}$ is the link's weight between the two species
\
\

**Second order indirect effects**
\

The weight of the indirect effect of species $i$ on E(D)S provided by species $j$ mediated by species $k$ ($S_{ikj}$)  will be equal to:
\
\

$S_{ikj}= w_{ik}\times w_{kj}$
\
\

where $w_{ik}$ is the link's weight between the species $i$ and $k$, and $w_{kj}$ is the link's weight between the species $j$ and $k$ 

\
\
\
\
\
\

### Number of indirect effects on E(D)S provision
\


```{r}

#Number of indirect effect ni removal

output_ind_ES <- read.csv("Land_use_output_weighted_trial_norem.csv", sep =",") 

Number<-output_ind_ES %>% group_by(management) %>% summarize(Number = n())

Number$management <- factor(Number$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

Number<-Number%>%   
  ggplot(aes(y=Number, x=management)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("no removal")+
  labs(x='Management', y="Number of indirect effects on E(D)S") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank())



#Number of indirect effect removal

output_ind_ES_rem <- read.csv("Land_use_output_weighted_trial_removal.csv", sep =",") 


Number_rem<-output_ind_ES_rem %>% group_by(management) %>% summarize(Number = n())

Number_rem$management <- factor(Number_rem$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors


Number_rem<-Number_rem%>%   
  ggplot(aes(y=Number, x=management)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("removal")+
  labs(x='Management', y="Number of indirect effects on E(D)S") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank())

upper_row<- plot_grid(Number,Number_rem ,
                  ncol = 2)
upper_row

```

### Ratio output +/-
\

```{r}

#ratio removal

output_ind_ES <- read.csv("Land_use_output_weighted_trial_norem.csv", sep =",") 

# ratio > 1 indicates more benefits, ratio = 1 balance between damages and benefits and ratio < 1 more damage

number_positive<-output_ind_ES %>% group_by(management) %>% 
  filter (output == "+") %>% summarise (positive = n())#count + outputs

number_negative<-output_ind_ES %>% group_by(management) %>% 
  filter (output == "-") %>% summarise (negative = n())#count - outputs

total<-cbind(number_positive,number_negative[,-1])

ratio_indirect<-total %>% mutate(ratio_direct = positive/negative)

ratio_indirect$management <- factor(ratio_indirect$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors


## ratio indirect

ratio_indirect<-ratio_indirect%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("no removal")+
  labs(x='Management', y="Prop of outputs (+/-)") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")


#ratio removal

output_ind_ES_rem <- read.csv("Land_use_output_weighted_trial_removal.csv", sep =",") 

# ratio > 1 indicates more benefits, ratio = 1 balance between damages and benefits and ratio < 1 more damage

number_positive<-output_ind_ES_rem %>% group_by(management) %>% 
  filter (output == "+") %>% summarise (positive = n())#count + outputs

number_negative<-output_ind_ES_rem %>% group_by(management) %>% 
  filter (output == "-") %>% summarise (negative = n())#count - outputs

total<-cbind(number_positive,number_negative[,-1])

ratio_indirect_rem<-total %>% mutate(ratio_direct = positive/negative)

ratio_indirect_rem$management <- factor(ratio_indirect_rem$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors


## ratio indirect

ratio_indirect_rem<-ratio_indirect_rem%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("removal")+
  labs(x='Management', y="Prop of outputs (+/-)") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")


upper_row<- plot_grid(ratio_indirect,ratio_indirect_rem ,
                  ncol = 2)
upper_row

```


### Weight of indirect effects according to output
\
```{r}

#no removal

output_ind_ES <- read.csv("Land_use_output_weighted_trial_norem.csv", sep =",") 

weights_management<-output_ind_ES %>% group_by(management, output) %>% 
                summarise(weight_mean = mean(weight),
                          weight_sd = sd(weight),
                          weight_se =  sd(weight) / sqrt(n()))#calculate avergae nad standart error
 
weights_management$management <- factor(weights_management$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

#barplot
weights_output_mangement<-weights_management %>% 
  ggplot(aes(y=weight_mean, x=management, fill =output)) + 
  geom_errorbar(
    aes(ymin =0 , ymax = weight_mean + weight_se),
    position = position_dodge(width = 0.9),
    width = 0.25
  ) +
  geom_bar(position="dodge", stat="identity")+ ggtitle("no removal")+
  labs(x='Management', y="Weight indirect effect") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")


#removal

output_ind_ES_rem <- read.csv("Land_use_output_weighted_trial_removal.csv", sep =",") 

weights_management_rem<-output_ind_ES_rem %>% group_by(management, output) %>% 
                summarise(weight_mean = mean(weight),
                          weight_sd = sd(weight),
                          weight_se =  sd(weight) / sqrt(n()))#calculate avergae nad standart error
 
weights_management_rem$management <- factor(weights_management_rem$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

#barplot
weights_output_mangement_rem<-weights_management_rem %>% 
  ggplot(aes(y=weight_mean, x=management, fill =output)) + 
  geom_errorbar(
    aes(ymin =0 , ymax = weight_mean + weight_se),
    position = position_dodge(width = 0.9),
    width = 0.25
  ) +
  geom_bar(position="dodge", stat="identity")+ ggtitle("removal")+
  labs(x='Management', y="Weight indirect effect") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.text.x= element_text(size =13, angle = 90), 
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11),
        legend.position = "bottom")




upper_row<- plot_grid(weights_output_mangement,weights_output_mangement_rem ,
                  ncol = 2)
upper_row

```



# Previous analysis

## Link duplication {.tabset}

### Direct provision E(D)S

#### ES/E(D)S

\
```{r}

ratio_direct <- read.csv("Land_use_rat_dir_binary.csv", sep =",") #ratio ES

ratio_direct$management <- factor(ratio_direct$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

ratio_direct_prov<-ratio_direct%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("Ratio direct ES/EDS")+
  labs(x='Manegement', y="Prop of E(D)S") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

ratio_direct_prov

```
\
\
\
\

#### Number of EDS provided per management
\

```{r}

direct_ES_binary <- read.csv("Land_use_dir_binary.csv", sep =",") #direct ES

direct_ES_binary$management <- factor(direct_ES_binary$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

ggplot_EDS_management<-direct_ES_binary %>% group_by(management) %>% count(services) %>% 
  ggplot(aes(y=n, x=management, fill = services)) + 
  geom_bar(position = "dodge" ,stat="identity")+ ggtitle("Direct EDS")+
  labs(x='Management', y="Direct EDS provided") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=13, color='black'),
        axis.text.x= element_text(size =11, angle = 90), 
        axis.text.y= element_text(size =11, angle = 90), 
        axis.title = element_text(size=15, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_blank(),
        legend.text = element_text(size = 8),
        legend.position = "bottom",
        legend.key.size = unit(0.7,"line"))

ggplot_EDS_management

```
\
\
\
\

### Indirect effect on ES

#### +/-
\
```{r}

output_ind_ES <- read.csv("Land_use_output_ind_binary.csv", sep =",") 

# ratio > 1 indicates more benefits, ratio = 1 balance between damages and benefits and ratio < 1 more damage

output_ind_ES$management <- factor(output_ind_ES$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

number_positive<-output_ind_ES %>% group_by(management) %>% 
  filter (output == "+") %>% summarise (positive = n())#count + outputs

number_negative<-output_ind_ES %>% group_by(management) %>% 
  filter (output == "-") %>% summarise (negative = n())#count - outputs

total<-cbind(number_positive,number_negative[,-1])

ratio_indirect<-total %>% mutate(ratio_direct = positive/negative)

ratio_indirect_prov<-ratio_indirect%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("Ratio indirect +/-")+
  labs(x='Manegement', y="Prop of outputs") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

ratio_indirect_prov

```
\
\
\
\

## Unique links (habitat loss) {.tabset}

### Direct provision E(D)S

#### ES/E(D)S
\
```{r}

ratio_direct <- read.csv("Land_use_rat_dir_binary_removal.csv", sep =",") #ratio ES

ratio_direct$management <- factor(ratio_direct$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

ratio_direct_prov<-ratio_direct%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("Ratio direct ES/EDS")+
  labs(x='Manegement', y="Prop of E(D)S") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

ratio_direct_prov

```
\
\
\
\

#### Number of EDS provided per management
\

```{r}

direct_ES_binary <- read.csv("Land_use_dir_binary_removal.csv", sep =",") #direct ES

direct_ES_binary$management <- factor(direct_ES_binary$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

ggplot_EDS_management<-direct_ES_binary %>% group_by(management) %>% count(services) %>% 
  ggplot(aes(y=n, x=management, fill = services)) + 
  geom_bar(position = "dodge" ,stat="identity")+ ggtitle("Direct EDS")+
  labs(x='Management', y="Direct EDS provided") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=13, color='black'),
        axis.text.x= element_text(size =11, angle = 90), 
        axis.text.y= element_text(size =11, angle = 90), 
        axis.title = element_text(size=15, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_blank(),
        legend.text = element_text(size = 8),
        legend.position = "bottom",
        legend.key.size = unit(0.7,"line"))

ggplot_EDS_management

```
\
\
\
\

\
\
\
\

### Indirect effect on ES

#### +/-
\
```{r}

output_ind_ES <- read.csv("Land_use_output_ind_binary_removal.csv", sep =",") 

# ratio > 1 indicates more benefits, ratio = 1 balance between damages and benefits and ratio < 1 more damage

output_ind_ES$management <- factor(output_ind_ES$management, levels = c("E", "SE", "M", "SI","I")) #change order of factors

number_positive<-output_ind_ES %>% group_by(management) %>% 
  filter (output == "+") %>% summarise (positive = n())#count + outputs

number_negative<-output_ind_ES %>% group_by(management) %>% 
  filter (output == "-") %>% summarise (negative = n())#count - outputs

total<-cbind(number_positive,number_negative[,-1])

ratio_indirect<-total %>% mutate(ratio_direct = positive/negative)

ratio_indirect_prov<-ratio_indirect%>% gather("type","value", 2:3) %>% group_by(management) %>% 
  mutate(Total = sum(value)) %>% group_by(management,type) %>% 
  summarise(prop = value /Total) %>%  
  ggplot(aes(y=prop, x=management, fill = type)) + 
  geom_bar(position="stack", stat="identity")+ ggtitle("Ratio indirect +/-")+
  labs(x='Manegement', y="Prop of outputs") +theme_bw()+
  theme_classic()+
  theme(panel.grid = element_blank(),
        panel.border = element_rect(color = "black",fill = NA,size = 1),
        panel.spacing = unit(0.5, "cm", data = NULL),
        axis.text = element_text(size=15, color='black'),
        axis.title = element_text(size=17, color='black'),
        axis.line = element_blank(),
        legend.text.align = 0,
        legend.title =  element_text(size = 13, color = "black"),
        legend.text = element_text(size = 11))

ratio_indirect_prov

```
\
\
\



# Next steps

\
<font size="4">
**Incorporate abundances of species and area of habitats**
\
\

<font size="4"> **Steps**
\
\

**1)** Create multilayer network with abundances as state nodes attributes (nodes' abundances per each habitat)
\
\

**2)** Change the habitats to "CP" but modifying the abundance of each species according to the area.
\
\

**3)** Aggregate the habitats to create the Norwoodfarm network. During this step, we add the abundances of the same species across habitats. Then, we calculate the weight of links between two species:

$w_{ji}=A_{j}\times A_{i}$
\

where $A_j$ and $A_i$ represent the relative abundance of species $j$ and $i$ in their trophic group.

