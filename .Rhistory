install.packages("devtools")
install.packages("devtools")
install.packages("devtools")
devtools::install_github("manlius/muxViz")
remove.packages("muxViz")
devtools::install_github("manlius/muxViz")
library(htmltools)
library(htmltools)
install.packages("htmltools")
detach("package:htmltools", unload = TRUE)
install.packages("htmltools")
devtools::install_github("manlius/muxViz")
install.packages("htmltools")
devtools::install_github("manlius/muxViz")
library(emln)#multilayer package
library(bipartite)
library(vegan)
library(sna)
library(tidyverse)
library(readxl)
setwd("D:/Trabajo/Papers/Norwood_Farm/norwood-ecosystem-services-main_Tinio")
### Upload list of nodes
Norwood_farm<-readRDS("Data/Norwood_farm.RData") #read multilayer object
### Create list of species
species_list<-Norwood_farm$nodes %>% select(node_id,node_name,taxon) %>%
separate(node_name, c("trophic_lower", "node_name"),  "[A-Z]\\.") %>%
select(-trophic_lower) %>% mutate (node_name =  gsub(c("\\?"), "", node_name)) %>%
mutate (node_name =  gsub(c("1"), "", node_name)) %>%
mutate (node_name =  gsub(c("zCROP"), "", node_name)) %>%
mutate (node_name = gsub("\\.", " ", node_name))#keep just the species name of most rows
#birds
birds.repo<-read.delim("Data/biomass_repositories/BirdFuncDat.txt") %>%
select(Scientific,BodyMass.Value) %>% rename("node_name" = "Scientific",
"biomass.g" = "BodyMass.Value")
#check for those species in the repository that match in our dataframe
mass.birds<- species_list %>% left_join(birds.repo, by = "node_name") %>%
filter(taxon =="Seed-feeding bird")
# mammals
mam.repo<-read.delim("Data/biomass_repositories/MamFuncDat.txt")%>%
select(Scientific,BodyMass.Value) %>% rename("node_name" = "Scientific",
"biomass.g" = "BodyMass.Value")
#check for those species in the repository that match in our dataframe
mass.mam<- species_list %>% left_join(mam.repo, by = "node_name") %>%
filter(taxon =="Seed-feeding rodent")
aphid.par.repo<-read.delim("Data/biomass_repositories/bodysizes_2008.txt")
filter_sps<-aphid.par.repo %>% filter(Taxonomy.consumer%in%species_list$node_name |
Taxonomy.resource%in%species_list$node_name) %>%
select(Taxonomy.consumer,Mean.mass..g..consumer,Taxonomy.resource,
Mean.mass..g..resource) %>%  #filter sps from the database
unique() #the biomass is already averaged
#Split consumer and resource information
upper<- filter_sps[,1:2] %>% rename("node_name" = "Taxonomy.consumer", "biomass.g" ="Mean.mass..g..consumer")
library(bipartite)
library(vegan)
library(sna)
library(tidyverse)
library(readxl)
setwd("D:/Trabajo/Papers/Norwood_Farm/norwood-ecosystem-services-main_Tinio")
### Upload list of nodes
Norwood_farm<-readRDS("Data/Norwood_farm.RData") #read multilayer object
### Create list of species
species_list<-Norwood_farm$nodes %>% select(node_id,node_name,taxon) %>%
separate(node_name, c("trophic_lower", "node_name"),  "[A-Z]\\.") %>%
select(-trophic_lower) %>% mutate (node_name =  gsub(c("\\?"), "", node_name)) %>%
mutate (node_name =  gsub(c("1"), "", node_name)) %>%
mutate (node_name =  gsub(c("zCROP"), "", node_name)) %>%
mutate (node_name = gsub("\\.", " ", node_name))#keep just the species name of most rows
#birds
birds.repo<-read.delim("Data/biomass_repositories/BirdFuncDat.txt") %>%
select(Scientific,BodyMass.Value) %>% rename("node_name" = "Scientific",
"biomass.g" = "BodyMass.Value")
#check for those species in the repository that match in our dataframe
mass.birds<- species_list %>% left_join(birds.repo, by = "node_name") %>%
filter(taxon =="Seed-feeding bird")
# mammals
mam.repo<-read.delim("Data/biomass_repositories/MamFuncDat.txt")%>%
select(Scientific,BodyMass.Value) %>% rename("node_name" = "Scientific",
"biomass.g" = "BodyMass.Value")
#check for those species in the repository that match in our dataframe
mass.mam<- species_list %>% left_join(mam.repo, by = "node_name") %>%
filter(taxon =="Seed-feeding rodent")
aphid.par.repo<-read.delim("Data/biomass_repositories/bodysizes_2008.txt")
filter_sps<-aphid.par.repo %>% filter(Taxonomy.consumer%in%species_list$node_name |
Taxonomy.resource%in%species_list$node_name) %>%
select(Taxonomy.consumer,Mean.mass..g..consumer,Taxonomy.resource,
Mean.mass..g..resource) %>%  #filter sps from the database
unique() #the biomass is already averaged
#Split consumer and resource information
upper<- filter_sps[,1:2] %>% rename("node_name" = "Taxonomy.consumer", "biomass.g" ="Mean.mass..g..consumer")
lower<-filter_sps[,3:4] %>% rename("node_name" = "Taxonomy.resource", "biomass.g" ="Mean.mass..g..resource")
#function to keep the first two words in species name from the repository
keep_first_two_words <- function(text) {
words <- str_split(text, "\\s+")[[1]]
paste(words[1:2], collapse = " ")
}
#apply function
aphid.par.bio<-rbind(upper,lower) %>% unique() %>%
filter(biomass.g >0) %>% #eliminate species with - biomass (error in dataframe)
mutate( node_name = sapply(node_name, keep_first_two_words)) %>%
mutate(node_name = gsub("\\bNA\\b", "", node_name)) #eliminate extra text in some columns
#add data of biomass manually and do the average for the rest
mass.aphid<- species_list %>% left_join(aphid.par.bio, by = "node_name") %>%
unique() %>%  mutate (biomass.g = case_when(node_name == "Acyrthosiphon pisum"~ 0.0008623,
node_name == "Myzus persicae"~ 0.0002042,
node_name == "Sitobion avenae"~ 0.0031632,
TRUE~biomass.g)) %>%
filter(taxon == "Aphid") %>% mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g))
#add data of biomass manually and do the average for the rest
mass.1.par<-species_list %>% left_join(aphid.par.bio, by = "node_name") %>%
unique() %>% filter(taxon == "Primary aphid parasitoid") %>%
mutate (biomass.g = case_when(node_name == "Aphidius rhopalosiphi"~ 0.000161,
node_name == "Aphidius matricariae"~ 0.00088,
TRUE~biomass.g)) %>% #add manually more data
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g))
mass.2.par<-species_list %>% left_join(aphid.par.bio, by = "node_name") %>%
unique() %>% filter(taxon == "Secondary aphid parasitoid")%>%
mutate (biomass.g = case_when(node_name == "Asaphes suspensus "~ 0.00000927,
TRUE~biomass.g)) %>% #add the data manually
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g)) #do the average for the rest
## Insect seed feeder parasitoid
mass.ins.par<-species_list %>% left_join(aphid.par.bio, by = "node_name") %>%
unique() %>% filter(taxon == "Insect seed-feeder parasitoid") %>%
mutate (biomass.g = case_when(node_name == "Pteromalus albipennis"~ 0.0013,
node_name == "Mesopolobus incultus"~ 0.00045,
node_name == "Pteromalus elevatus"~ 0.0121,
node_name == "Bracon immutator"~ 0.0025,
node_name == "Bracon osculator"~ 0.0025,
node_name == "Bracon praecox"~ 0.0025,
TRUE~biomass.g)) %>% #add manually more data
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g)) #do the average for the rest
mass.seed.ins<-species_list %>% left_join(aphid.par.bio, by = "node_name") %>%
unique() %>% filter(taxon == "Seed-feeding insect")  %>%
mutate (biomass.g = case_when(node_name == "Bruchidius varius"~ 0.003,
node_name == "Olibrus aeneus"~ 0.000251,
node_name == "Rhinocyllus conicus"~ 0.00845,
node_name == "Sitona lineatus"~ 0.00165,
node_name == "Urophora stylata"~ 0.0041,
TRUE~biomass.g)) %>% #add manually more data
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g)) #do the average for the rest
## Leaf miners (do the average of all the parastioids (do it before averaging them)
mass.leaf.min.par<-species_list %>% left_join(aphid.par.bio, by = "node_name") %>%
unique() %>% filter(taxon == "Leaf-miner parasitoid")  %>%
mutate (biomass.g = case_when(node_name == "Bracon sp"~ 0.0025,
node_name == "Apanteles circumscriptus" ~ 0.0089,
node_name == "Anagrus sp A" ~ 0.0000288,
node_name == "Anagrus sp B" ~ 0.0000288,
node_name == "Anagrus sp C" ~ 0.0000288,
node_name == "Asaphes suspensus"~ 0.00000927,
node_name == "Chelonus sp"~ 0.0069,
node_name == "Chelonus sp aff rimatus"~ 0.0069,
node_name == "Chelonus scabrosus"~ 0.0069,
node_name == "Diadegma crataegi"~ 0.000674,
TRUE~biomass.g)) %>% #add manually more data
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g)) #do the average for the rest
mass.flea<-species_list %>% filter (taxon =="Rodent ectoparasite") %>%
mutate(biomass.g = 0.000765)
mass.crop<-species_list %>% filter (taxon =="Crop") %>%
mutate (biomass.g = case_when(node_name == " Barley"~ 200,
node_name == " Lucerne" ~ 500,
node_name == " Oat spring" ~ 300,
node_name == " Oat winter" ~ 300,
node_name == " Triticale" ~ 500,
node_name == " Wheat"~ 250))#add manually more data
#repository of pollinators
library(pollimetry) #package containing data of pollinators
pollimetry_dataset$Weight<-as.numeric(pollimetry_dataset$Weight) #repository of pollinators
poll_list_repo<-pollimetry_dataset  %>%  select(Region,Country,Species,Weight) %>%
filter(Region == "Europe" & !(is.na(Weight))) %>%
mutate(Species = gsub("_", " ", Species),
Weight = Weight / 1000) %>% #to gr
group_by(Species) %>% summarise(biomass.g = mean (Weight)) # calculate average of Weight
# Check row dataframe to separate the flower visitor guild
nore<-read.csv("Data/nore2.csv",header=T)
lower.guild<-substr(nore$lower,1,4)
upper.guild<-substr(nore$upper,1,4)
nore<-cbind(nore,lower.guild,upper.guild)
## Bees
bees<-nore %>% filter(upper.guild == "10BE") %>% select(upper,upper.guild) %>%
unique() %>% mutate(upper = substring(upper, 7)) #list of bees
bees.list<-species_list %>% filter(node_name%in%bees$upper)#select bees from the whole species list
#check for those species in the repository that match in our dataframe
mass.bees<- bees.list %>% left_join(poll_list_repo, by = c("node_name"="Species")) %>%
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g)) #do the average for the rest
## Hover flies
hov<-nore %>% filter(upper.guild == "11HO") %>% select(upper,upper.guild) %>%
unique() %>% mutate(upper = substring(upper, 7)) #list of hover flies
hov.list<-species_list %>% filter(node_name%in%hov$upper)#select hover flies from the whole species list
#check for those species in the repository that match in our dataframe
mass.hov<- hov.list %>% left_join(poll_list_repo, by = c("node_name"="Species")) %>%
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g)) #do the average for the rest
## Other flower visitors
ot.flw<-nore %>% filter(upper.guild == "15FV") %>% select(upper,upper.guild) %>%
unique() %>% mutate(upper = substring(upper, 11)) %>%  #list of other flower visitors
mutate (upper =  gsub(c("\\?"), "", upper)) %>%
mutate (upper =  gsub(c("1"), "", upper)) %>%
mutate (upper =  gsub(c("zCROP"), "", upper)) %>%
mutate (upper = gsub("\\.", " ", upper))#keep just the species name of most rows
ot.flw.list<-species_list %>% filter(node_name%in%ot.flw$upper) %>%  #select other flower visitors from the whole species list
filter(taxon == "Flower-visiting")
#upload repository
repo_1<-read_excel("Data/biomass_repositories/coleoptera.xlsx", sheet = 3)
repo_1_clean<-repo_1%>% select(Species, 'Mean mass (mg)')
repo_1_clean$`Mean mass (mg)`<-as.numeric(repo_1_clean$`Mean mass (mg)`)
repo_1_final<-repo_1_clean %>%
mutate(biomass.g = `Mean mass (mg)`/1000) #convert to g
#check for those species in the repository that match in our dataframe
mass.ot.flw1<- ot.flw.list %>% left_join(repo_1_final, by = c("node_name"="Species"))
#manually
mass.ot.flw<- mass.ot.flw1 %>% mutate (biomass.g = case_when(node_name == "Bracon sp"~ 0.0025,
node_name == "Olibrus aeneus"~ 0.000251,
node_name == "Agriotes pallidulus"~  0.01966667,
node_name == "Aprostocetus sp"~  0.00008,
node_name == "Grammoptera ruficornis"~  0.005143,
node_name == "Hemicrepidius memnonius"~  0.0327,
node_name == "Rhagonycha fulva"~ 0.0015275,
node_name == "Sitona puncticollis"~ 0.00165)) %>%
mutate(biomass.g =if_else(is.na(biomass.g),
mean(biomass.g, na.rm = TRUE), biomass.g)) %>%
select (node_id,node_name,taxon,biomass.g)#do the average for the rest
#manually add the biomass according to bibliiography
mass.butt<-species_list %>% filter (taxon =="Butterfly") %>%
mutate (biomass.g = case_when(node_name == "Comma"~ 0.0413,
node_name == "Green-veined White"~ 0.056,
node_name == "Large White"~ 0.128,
node_name == "Gatekeeper"~ 0.040,
node_name == "Common blue"~  0.0118,
node_name == "Meadow Brown"~  0.0215,
node_name == "Painted Lady"~  0.0725,
node_name == "Peacock"~  0.078,
node_name == "Red Admiral"~ 0.0725,
node_name == "Ringlet"~ 0.0376,
node_name == "Small copper"~  0.051,
node_name == "Small Skipper"~  0.061,
node_name == "Large Skipper"~  0.088,
node_name == "Small tortoiseshell"~ 0.136,
node_name == "Small white"~ 0.067,
node_name == "Speckled wood"~ 0.041)) %>% #add manually
select (node_id,node_name,taxon,biomass.g)#do the average for the rest
######## -- Create dry mass final dataset of species providing directly and E(D)S
full_list<-rbind(mass.leaf.min.par,mass.seed.ins,mass.ins.par,mass.2.par,mass.1.par,
mass.aphid,mass.hov,mass.bees,mass.flea,mass.birds,mass.crop, mass.mam,mass.ot.flw,mass.butt) %>%
select(node_id,biomass.g)
mass.species.list<-species_list %>% left_join(full_list,by="node_id")
View(mass.species.list)
list.butt<-mass.species.list %>% filter(taxon == "Flower-visiting" & is.na(biomass.g) & node_id >150)
View(mass.species.list)
write.csv(mass.species.list,"Data/biomass.csv", row.names= FALSE)
