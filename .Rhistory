group_by(node_id) %>%
mutate(rel_ab=abun/tot_ab_taxon)#relative abundance per sp
# incorporate rel abundances to the edge list and calculate the weight (Product of relative abundances)
ext_edgelist_aggr<- extensive_edgelist %>% left_join(ab_ext, by = c("node_from" = "node_id")) %>%
left_join(ab_ext, by = c("node_to" = "node_id")) %>%
rename ("rel_ab_from" = "rel_ab.x", "rel_ab_to" = "rel_ab.y") %>%
mutate(weight = rel_ab_from * rel_ab_to) %>% #calculate weight
select(node_from,node_to,weight,management)
sem_ext_edgelist_rem<- Norwood_farm$extended_ids %>% filter(layer_from != 8 & layer_from != 10) %>%
select(-layer_to) %>% rename("habitat" = "layer_from") %>%   #links from "WD" and "RG" removed
left_join(state_nodes_ab, by = c("node_from" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of node_from
left_join(state_nodes_ab, by = c("node_to" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to" = "abundance.y", "taxon_node_to" = "taxon.y")
sem_ext_edgelist_rem<-sem_ext_edgelist_rem[,c(1,2,5,6,3,7,8,4)]
# create habitats CP to replace WD and RG
WD_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 11, prev_hab = "WD", hab_cp = "CP")#links from "CP" to add as new habitat (12)
RG_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 12, prev_hab = "RG", hab_cp = "CP")#links from "CP" to add as new habitat (13)
View(GM_CP)
#calculate changes in the area between CP and the habitat to replace
converted_area<-rbind(WD_CP, RG_CP) %>% left_join(habitat_area,
by = c("prev_hab" = "HabitatCode")) %>%
left_join(habitat_area, by = c("hab_cp" = "HabitatCode")) %>%
select(node_from,node_to,weight,new_hab,prev_hab,hab_cp,area_ave.x,area_ave.y) %>%
rename("area_prev_hab" ="area_ave.x", "area_CP" = "area_ave.y") %>%
mutate(mult_ab = (area_prev_hab/area_CP)) %>% #multplied abundances of CP for this value (to estimate according to the new habitat)
select(-prev_hab,-hab_cp,-area_prev_hab,-area_CP)#clean dataframe
# add abundances and modify it according to the new area
abundances_CP<-state_nodes_ab %>% filter(layer_id ==1)#filter species abundances to show just layer CP
new_habitats_ab<-converted_area %>%
left_join(abundances_CP, by = c("node_from" = "node_id")) %>%  #incorporate abundances and taxa of node_from
left_join(abundances_CP, by = c("node_to" = "node_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from_CP" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to_CP" = "abundance.y", "taxon_node_to" = "taxon.y") %>%
mutate(ab_node_from = ab_node_from_CP * mult_ab,
ab_node_to = ab_node_to_CP * mult_ab ) %>% #estimate the new abundances
select(new_hab,node_from,ab_node_from,taxon_node_from,node_to,ab_node_to,
taxon_node_to,weight) %>% rename ("habitat" = "new_hab") #clean to match the rest of farm edgelist
new_habitats_ab_rem<- new_habitats_ab %>% filter(ab_node_from >=1 & ab_node_to >=1)
#species in the new habitat
sp_WD_RG <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 11 ~ "WD",
habitat == 12 ~ "RG"
))
sp_WD<-sp_WD_RG %>% filter(habitat=="WD")
sp_RG<-sp_WD_RG %>% filter(habitat=="RG")
View(sp_WD_RG)
View(new_habitats_ab_rem)
sp_WD_RG <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat)
View(sp_WD_RG)
sp_WD_RG <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3)
sp_WD_RG <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 11 ~ "WD",
habitat == 12 ~ "RG"
))
sp_WD<-sp_WD_RG %>% filter(habitat=="WD")
sp_RG<-sp_WD_RG %>% filter(habitat=="RG")
View(sp_WD)
View(sp_lost_WD)
sp_lost_RG <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "RG") %>% #species in the original habitats
filter(!(node_id %in%sp_RG$node_id))
View(RG_CP)
View(sp_WD)
View(WD_CP)
#species lost from the new habitat
sp_lost_WD <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "WD") %>% #species in the original habitats
filter!(node_id %in%sp_WD$node_id)
#species lost from the new habitat
sp_lost_WD <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "WD") %>% #species in the original habitats
filter(!node_id %in%sp_WD$node_id)
sp_lost_RG <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "RG") %>% #species in the original habitats
filter(!(node_id %in%sp_RG$node_id))
sp_lost_RG <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "RG") %>% #species in the original habitats
filter(!node_id %in%sp_RG$node_id)
View(sp_lost_RG)
View(sp_RG)
View(sp_WD)
View(sp_lost_WD)
sp_lost_RG <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "RG") %>% #species in the original habitats
filter(!node_id %in%sp_RG$node_id))
#species lost from the new habitat
sp_lost_WD <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "WD") %>% #species in the original habitats
filter(!node_id %in%sp_WD$node_id)
sp_lost_RG <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "RG") %>% #species in the original habitats
filter(!node_id %in%sp_RG$node_id)
sem_ext_edgelist_no_aggr<- rbind(sem_ext_edgelist_rem,new_habitats_ab_rem)  #join new habitats and old habitats
#node_from
state_node_sem_ext_from<- sem_ext_edgelist_no_aggr %>% select(habitat,node_from,ab_node_from,
taxon_node_from) %>%
rename("node_id" ="node_from", "abundances" = "ab_node_from",
"taxon" = "taxon_node_from") %>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
#node_to
state_node_sem_ext_to<- sem_ext_edgelist_no_aggr %>% select(habitat,node_to,ab_node_to,
taxon_node_to) %>%
rename("node_id" ="node_to", "abundances" = "ab_node_to",
"taxon" = "taxon_node_to") %>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
state_node_sem_ext_agg<-rbind(state_node_sem_ext_from, state_node_sem_ext_to) %>% ungroup() %>%
select(-habitat) %>% group_by(node_id,taxon) %>%
mutate(abun = sum(abundances)) %>% distinct(abun) %>% group_by(taxon) %>%
mutate(tot_ab_taxon = sum(abun)) %>% #total abundance per taxon
group_by(node_id) %>%
mutate(rel_ab=abun/tot_ab_taxon)#rel abundance of species per taxon
sem_ext_edgelist_aggr<-sem_ext_edgelist_no_aggr %>% select(node_from,node_to) %>%
unique() %>%  #aggregated edge list
left_join(state_node_sem_ext_agg, by = c("node_from" = "node_id")) %>%  #incorporate rel abundances of node_from
left_join(state_node_sem_ext_agg, by = c("node_to" = "node_id")) %>%  #incorporate rel abundances of nodes_to
select(node_from,node_to, rel_ab.x,rel_ab.y) %>%
mutate(weight = rel_ab.x * rel_ab.y,management = "SE") %>% #calculate weight
select(-rel_ab.x,-rel_ab.y)
mod_edgelist_rem<- Norwood_farm$extended_ids %>%
filter(layer_from != 8 & layer_from != 10 & layer_from != 4 & layer_from != 5) %>% #links from "WD", "RG", "MH", and "NH" removed
select(-layer_to) %>% rename("habitat" = "layer_from") %>%
left_join(state_nodes_ab, by = c("node_from" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of node_from
left_join(state_nodes_ab, by = c("node_to" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to" = "abundance.y", "taxon_node_to" = "taxon.y")
mod_edgelist_rem<-mod_edgelist_rem[,c(1,2,5,6,3,7,8,4)]
# create habitats CP to replace WD,RG, MH and NH (WD and RG were created before)
MH_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 13, prev_hab = "MH", hab_cp = "CP")#links from "CP" to add as new habitat (14)
NH_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 14, prev_hab = "NH", hab_cp = "CP")#links from "CP" to add as new habitat (15)
# calculate changes in the area between CP and the habitat to replace
converted_area<-rbind(WD_CP, RG_CP, MH_CP, NH_CP) %>% left_join(habitat_area,
by = c("prev_hab" = "HabitatCode")) %>%
left_join(habitat_area, by = c("hab_cp" = "HabitatCode")) %>%
select(node_from,node_to,weight,new_hab,prev_hab,hab_cp,area_ave.x,area_ave.y) %>%
rename("area_prev_hab" ="area_ave.x", "area_CP" = "area_ave.y") %>%
mutate(mult_ab = (area_prev_hab/area_CP)) %>% #multplied abundances of CP for this value (to estimate according to the new habitat)
select(-prev_hab,-hab_cp,-area_prev_hab,-area_CP)#clean dataframe
# add abundances and modify them according to the new area
abundances_CP<-state_nodes_ab %>% filter(layer_id ==1)#filter species abundances to show just layer CP
new_habitats_ab<-converted_area %>%
left_join(abundances_CP, by = c("node_from" = "node_id")) %>%  #incorporate abundances and taxa of node_from
left_join(abundances_CP, by = c("node_to" = "node_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from_CP" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to_CP" = "abundance.y", "taxon_node_to" = "taxon.y") %>%
mutate(ab_node_from = ab_node_from_CP * mult_ab,
ab_node_to = ab_node_to_CP * mult_ab ) %>% #estimate the new abundances
select(new_hab,node_from,ab_node_from,taxon_node_from,node_to,ab_node_to,
taxon_node_to,weight) %>% rename ("habitat" = "new_hab") #clean to match the rest of farm edgelist
new_habitats_ab_rem<- new_habitats_ab %>% filter(ab_node_from >=1 & ab_node_to >=1)
#species in the new habitat
sp_MH_NH <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 13 ~ "MH",
habitat == 14 ~ "NH"
))
sp_MH<-sp_MH_NH %>% filter(habitat=="MH")
sp_NH<-sp_MH_NH %>% filter(habitat=="NH")
sp_MH<-sp_MH_NH %>% filter(habitat=="MH")
sp_NH<-sp_MH_NH %>% filter(habitat=="NH")
#species lost from the new habitat
sp_lost_MH <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "MH") %>% #species in the original habitats
filter(!node_id %in%sp_MH$node_id)
sp_lost_NH <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "NH") %>% #species in the original habitats
filter(!node_id %in%sp_NH$node_id)
View(sp_MH)
View(sp_lost_MH)
#species lost from the new habitat
sp_lost_MH <- Norwood_farm$state_nodes %>% select(layer_name,node_id) %>%
filter(layer_name == "MH") %>% #species in the original habitats
mutate(tot_sp = nrow(.)) %>%
filter(!node_id %in%sp_MH$node_id)
View(sp_lost_MH)
View(sp_MH_NH)
sp_MH_NH <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 13 ~ "MH",
habitat == 14 ~ "NH"
))
View(sp_WD_RG)
# create habitats CP to replace WD and RG
WD_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 11, prev_hab = "WD", hab_cp = "CP")#links from "CP" to add as new habitat (12)
RG_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 12, prev_hab = "RG", hab_cp = "CP")#links from "CP" to add as new habitat (13)
#calculate changes in the area between CP and the habitat to replace
converted_area<-rbind(WD_CP, RG_CP) %>% left_join(habitat_area,
by = c("prev_hab" = "HabitatCode")) %>%
left_join(habitat_area, by = c("hab_cp" = "HabitatCode")) %>%
select(node_from,node_to,weight,new_hab,prev_hab,hab_cp,area_ave.x,area_ave.y) %>%
rename("area_prev_hab" ="area_ave.x", "area_CP" = "area_ave.y") %>%
mutate(mult_ab = (area_prev_hab/area_CP)) %>% #multplied abundances of CP for this value (to estimate according to the new habitat)
select(-prev_hab,-hab_cp,-area_prev_hab,-area_CP)#clean dataframe
# add abundances and modify it according to the new area
abundances_CP<-state_nodes_ab %>% filter(layer_id ==1)#filter species abundances to show just layer CP
new_habitats_ab<-converted_area %>%
left_join(abundances_CP, by = c("node_from" = "node_id")) %>%  #incorporate abundances and taxa of node_from
left_join(abundances_CP, by = c("node_to" = "node_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from_CP" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to_CP" = "abundance.y", "taxon_node_to" = "taxon.y") %>%
mutate(ab_node_from = ab_node_from_CP * mult_ab,
ab_node_to = ab_node_to_CP * mult_ab ) %>% #estimate the new abundances
select(new_hab,node_from,ab_node_from,taxon_node_from,node_to,ab_node_to,
taxon_node_to,weight) %>% rename ("habitat" = "new_hab") #clean to match the rest of farm edgelist
new_habitats_ab_rem<- new_habitats_ab %>% filter(ab_node_from >=1 & ab_node_to >=1)
#species in the new habitat
sp_WD_RG <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 11 ~ "WD",
habitat == 12 ~ "RG"
))
#species in the new habitat
sp_WD_RG <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 11 ~ "WD",
habitat == 12 ~ "RG"
))
View(sp_WD_RG)
sem_ext_edgelist_no_aggr<- rbind(sem_ext_edgelist_rem,new_habitats_ab_rem)  #join new habitats and old habitats
#node_from
state_node_sem_ext_from<- sem_ext_edgelist_no_aggr %>% select(habitat,node_from,ab_node_from,
taxon_node_from) %>%
rename("node_id" ="node_from", "abundances" = "ab_node_from",
"taxon" = "taxon_node_from") %>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
#node_to
state_node_sem_ext_to<- sem_ext_edgelist_no_aggr %>% select(habitat,node_to,ab_node_to,
taxon_node_to) %>%
rename("node_id" ="node_to", "abundances" = "ab_node_to",
"taxon" = "taxon_node_to") %>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
state_node_sem_ext_agg<-rbind(state_node_sem_ext_from, state_node_sem_ext_to) %>% ungroup() %>%
select(-habitat) %>% group_by(node_id,taxon) %>%
mutate(abun = sum(abundances)) %>% distinct(abun) %>% group_by(taxon) %>%
mutate(tot_ab_taxon = sum(abun)) %>% #total abundance per taxon
group_by(node_id) %>%
mutate(rel_ab=abun/tot_ab_taxon)#rel abundance of species per taxon
sem_ext_edgelist_aggr<-sem_ext_edgelist_no_aggr %>% select(node_from,node_to) %>%
unique() %>%  #aggregated edge list
left_join(state_node_sem_ext_agg, by = c("node_from" = "node_id")) %>%  #incorporate rel abundances of node_from
left_join(state_node_sem_ext_agg, by = c("node_to" = "node_id")) %>%  #incorporate rel abundances of nodes_to
select(node_from,node_to, rel_ab.x,rel_ab.y) %>%
mutate(weight = rel_ab.x * rel_ab.y,management = "SE") %>% #calculate weight
select(-rel_ab.x,-rel_ab.y)
mod_edgelist_rem<- Norwood_farm$extended_ids %>%
filter(layer_from != 8 & layer_from != 10 & layer_from != 4 & layer_from != 5) %>% #links from "WD", "RG", "MH", and "NH" removed
select(-layer_to) %>% rename("habitat" = "layer_from") %>%
left_join(state_nodes_ab, by = c("node_from" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of node_from
left_join(state_nodes_ab, by = c("node_to" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to" = "abundance.y", "taxon_node_to" = "taxon.y")
mod_edgelist_rem<-mod_edgelist_rem[,c(1,2,5,6,3,7,8,4)]
# create habitats CP to replace WD,RG, MH and NH (WD and RG were created before)
MH_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 13, prev_hab = "MH", hab_cp = "CP")#links from "CP" to add as new habitat (14)
NH_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 14, prev_hab = "NH", hab_cp = "CP")#links from "CP" to add as new habitat (15)
# calculate changes in the area between CP and the habitat to replace
converted_area<-rbind(WD_CP, RG_CP, MH_CP, NH_CP) %>% left_join(habitat_area,
by = c("prev_hab" = "HabitatCode")) %>%
left_join(habitat_area, by = c("hab_cp" = "HabitatCode")) %>%
select(node_from,node_to,weight,new_hab,prev_hab,hab_cp,area_ave.x,area_ave.y) %>%
rename("area_prev_hab" ="area_ave.x", "area_CP" = "area_ave.y") %>%
mutate(mult_ab = (area_prev_hab/area_CP)) %>% #multplied abundances of CP for this value (to estimate according to the new habitat)
select(-prev_hab,-hab_cp,-area_prev_hab,-area_CP)#clean dataframe
# add abundances and modify them according to the new area
abundances_CP<-state_nodes_ab %>% filter(layer_id ==1)#filter species abundances to show just layer CP
new_habitats_ab<-converted_area %>%
left_join(abundances_CP, by = c("node_from" = "node_id")) %>%  #incorporate abundances and taxa of node_from
left_join(abundances_CP, by = c("node_to" = "node_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from_CP" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to_CP" = "abundance.y", "taxon_node_to" = "taxon.y") %>%
mutate(ab_node_from = ab_node_from_CP * mult_ab,
ab_node_to = ab_node_to_CP * mult_ab ) %>% #estimate the new abundances
select(new_hab,node_from,ab_node_from,taxon_node_from,node_to,ab_node_to,
taxon_node_to,weight) %>% rename ("habitat" = "new_hab") #clean to match the rest of farm edgelist
new_habitats_ab_rem<- new_habitats_ab %>% filter(ab_node_from >=1 & ab_node_to >=1)
#species in the new habitat
sp_MH_NH <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 13 ~ "MH",
habitat == 14 ~ "NH"
))
mod_edgelist_no_aggr<- rbind(mod_edgelist_rem,new_habitats_ab_rem)  #join new habitats and old habitats
#node_from
state_node_mod_from<- mod_edgelist_no_aggr %>% select(habitat,node_from,ab_node_from,
taxon_node_from) %>%
rename("node_id" ="node_from", "abundances" = "ab_node_from",
"taxon" = "taxon_node_from") %>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
#node_to
state_node_mod_to<- mod_edgelist_no_aggr %>% select(habitat,node_to,ab_node_to,
taxon_node_to) %>%
rename("node_id" ="node_to", "abundances" = "ab_node_to",
"taxon" = "taxon_node_to") %>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
state_node_mod_agg<-rbind(state_node_mod_from, state_node_mod_to) %>% ungroup() %>%
select(-habitat) %>% group_by(node_id,taxon) %>%
mutate(abun = sum(abundances)) %>% distinct(abun) %>% group_by(taxon) %>%
mutate(tot_ab_taxon = sum(abun)) %>% #total abundance per taxon
group_by(node_id) %>%
mutate(rel_ab=abun/tot_ab_taxon)#rel abundance of species per taxon
mod_edgelist_aggr<-mod_edgelist_no_aggr %>% select(node_from,node_to) %>%
unique() %>%  #aggregated edge list
left_join(state_node_mod_agg, by = c("node_from" = "node_id")) %>%  #incorporate rel abundances of node_from
left_join(state_node_mod_agg, by = c("node_to" = "node_id")) %>%  #incorporate rel abundances of nodes_to
select(node_from,node_to, rel_ab.x,rel_ab.y) %>%
mutate(weight = rel_ab.x * rel_ab.y,management = "M") %>% #calculate weight
select(-rel_ab.x,-rel_ab.y)
sem_int_edgelist_rem<- Norwood_farm$extended_ids %>%
filter(layer_from != 8 & layer_from != 10 &  layer_from != 4 &
layer_from != 5 & layer_from != 2 & layer_from != 9 &
layer_from != 7 ) %>% #links from "WD", "RG", "MH", "NH","GM", "SF" and "PP"" removed
select(-layer_to) %>% rename("habitat" = "layer_from") %>%
left_join(state_nodes_ab, by = c("node_from" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of node_from
left_join(state_nodes_ab, by = c("node_to" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to" = "abundance.y", "taxon_node_to" = "taxon.y")
sem_int_edgelist_rem<-sem_int_edgelist_rem[,c(1,2,5,6,3,7,8,4)]
# create habitats CP to replace WD,RG, MH,NH and GM (WD,RG,MH and NH were created before)
GM_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 15, prev_hab = "GM", hab_cp = "CP")#links from "CP" to add as new habitat (16)
SF_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 16, prev_hab = "SF", hab_cp = "CP")#links from "CP" to add as new habitat (17)
PP_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 17, prev_hab = "PP", hab_cp = "CP")#links from "CP" to add as new habitat (18)
# calculate changes in the area between CP and the habitat to replace
converted_area<-rbind(WD_CP, RG_CP, MH_CP, NH_CP, GM_CP,SF_CP,PP_CP) %>%
left_join(habitat_area,  by = c("prev_hab" = "HabitatCode")) %>%
left_join(habitat_area, by = c("hab_cp" = "HabitatCode")) %>%
select(node_from,node_to,weight,new_hab,prev_hab,hab_cp,area_ave.x,area_ave.y) %>%
rename("area_prev_hab" ="area_ave.x", "area_CP" = "area_ave.y") %>%
mutate(mult_ab = (area_prev_hab/area_CP)) %>% #multplied abundances of CP for this value (to estimate according to the new habitat)
select(-prev_hab,-hab_cp,-area_prev_hab,-area_CP)#clean dataframe
# add abundances and modify them according to the new area
abundances_CP<-state_nodes_ab %>% filter(layer_id ==1)#filter species abundances to show just layer CP
new_habitats_ab<-converted_area %>%
left_join(abundances_CP, by = c("node_from" = "node_id")) %>%  #incorporate abundances and taxa of node_from
left_join(abundances_CP, by = c("node_to" = "node_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from_CP" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to_CP" = "abundance.y", "taxon_node_to" = "taxon.y") %>%
mutate(ab_node_from = ab_node_from_CP * mult_ab,
ab_node_to = ab_node_to_CP * mult_ab ) %>% #estimate the new abundances
select(new_hab,node_from,ab_node_from,taxon_node_from,node_to,ab_node_to,
taxon_node_to,weight) %>% rename ("habitat" = "new_hab") #clean to match the rest of farm edgelist
new_habitats_ab_rem<- new_habitats_ab %>% filter(ab_node_from >=1 & ab_node_to >=1)
#species in the new habitat
sp_GM_SF_PP <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 15 ~ "GM",
habitat == 16 ~ "SF",
habitat == 17 ~ "PP"
))
sem_int_edgelist_no_aggr<- rbind(sem_int_edgelist_rem,new_habitats_ab_rem)  #join new habitats and old habitats
#node_from
state_node_sem_int_from<- sem_int_edgelist_no_aggr %>% select(habitat,node_from,ab_node_from,
taxon_node_from) %>%
rename("node_id" ="node_from", "abundances" = "ab_node_from",
"taxon" = "taxon_node_from")%>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
#node_to
state_node_sem_int_to<- sem_int_edgelist_no_aggr %>% select(habitat,node_to,ab_node_to,
taxon_node_to) %>%
rename("node_id" ="node_to", "abundances" = "ab_node_to",
"taxon" = "taxon_node_to")%>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
state_node_sem_int_agg<-rbind(state_node_sem_int_from, state_node_sem_int_to) %>% ungroup() %>%
select(-habitat) %>% group_by(node_id,taxon) %>%
mutate(abun = sum(abundances)) %>% distinct(abun) %>% group_by(taxon) %>%
mutate(tot_ab_taxon = sum(abun)) %>% #total abundance per taxon
group_by(node_id) %>%
mutate(rel_ab=abun/tot_ab_taxon)#rel abundance of species per taxon
sem_int_edgelist_aggr<-sem_int_edgelist_no_aggr %>% select(node_from,node_to) %>%
unique() %>%  #aggregated edge list
left_join(state_node_sem_int_agg, by = c("node_from" = "node_id")) %>%  #incorporate rel abundances of node_from
left_join(state_node_sem_int_agg, by = c("node_to" = "node_id")) %>%  #incorporate rel abundances of nodes_to
select(node_from,node_to, rel_ab.x,rel_ab.y) %>%
mutate(weight = rel_ab.x * rel_ab.y,management = "SI") %>% #calculate weight
select(-rel_ab.x,-rel_ab.y)
int_edgelist_rem<- Norwood_farm$extended_ids %>%
filter(layer_from != 8 & layer_from != 10 &  layer_from != 4 &
layer_from != 5  &  layer_from != 2 &layer_from != 9 &
layer_from != 7& layer_from != 3 &  layer_from != 6 ) %>% #links from "WD", "RG", "MH", "NH","GM","SF", "PP", "LP","LU", and"NL removed
select(-layer_to) %>% rename("habitat" = "layer_from") %>%
left_join(state_nodes_ab, by = c("node_from" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of node_from
left_join(state_nodes_ab, by = c("node_to" = "node_id",
"habitat" = "layer_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to" = "abundance.y", "taxon_node_to" = "taxon.y")
int_edgelist_rem<-int_edgelist_rem[,c(1,2,5,6,3,7,8,4)]
# create habitats CP to replace LP,LU and NL (the rest were created before)
LP_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 18, prev_hab = "LP", hab_cp = "CP")#links from "CP" to add as new habitat (19)
NL_CP<- Norwood_farm$extended_ids %>% filter(layer_from  == 1) %>% select(-layer_to,-layer_from) %>%
mutate (new_hab = 19, prev_hab = "NL", hab_cp = "CP")#links from "CP" to add as new habitat (21)
# calculate changes in the area between CP and the habitat to replace
converted_area<-rbind(WD_CP, RG_CP, MH_CP, NH_CP, GM_CP,SF_CP,PP_CP, LP_CP,NL_CP) %>%
left_join(habitat_area,   by = c("prev_hab" = "HabitatCode")) %>%
left_join(habitat_area, by = c("hab_cp" = "HabitatCode")) %>%
select(node_from,node_to,weight,new_hab,prev_hab,hab_cp,area_ave.x,area_ave.y) %>%
rename("area_prev_hab" ="area_ave.x", "area_CP" = "area_ave.y") %>%
mutate(mult_ab = (area_prev_hab/area_CP)) %>% #multplied abundances of CP for this value (to estimate according to the new habitat)
select(-prev_hab,-hab_cp,-area_prev_hab,-area_CP)#clean dataframe
# add abundances and modify them according to the new area
abundances_CP<-state_nodes_ab %>% filter(layer_id ==1)#filter species abundances to show just layer CP
new_habitats_ab<-converted_area %>%
left_join(abundances_CP, by = c("node_from" = "node_id")) %>%  #incorporate abundances and taxa of node_from
left_join(abundances_CP, by = c("node_to" = "node_id")) %>%  #incorporate abundances and taxa of nodes_to
rename("ab_node_from_CP" = "abundance.x", "taxon_node_from" = "taxon.x",
"ab_node_to_CP" = "abundance.y", "taxon_node_to" = "taxon.y") %>%
mutate(ab_node_from = ab_node_from_CP * mult_ab,
ab_node_to = ab_node_to_CP * mult_ab ) %>% #estimate the new abundances
select(new_hab,node_from,ab_node_from,taxon_node_from,node_to,ab_node_to,
taxon_node_to,weight) %>% rename ("habitat" = "new_hab") #clean to match the rest of farm edgelist
new_habitats_ab_rem<- new_habitats_ab %>% filter(ab_node_from >=1 & ab_node_to >=1)
#species in the new habitat
sp_LP_NL <- new_habitats_ab_rem %>%select(habitat,node_from,node_to) %>% group_by(habitat) %>%
gather("type","node_id",2:3) %>% select(habitat, node_id) %>% unique() %>%
mutate(habitat = case_when (
habitat == 18 ~ "LP",
habitat == 19 ~ "NL"
))
int_edgelist_no_aggr<- rbind(int_edgelist_rem,new_habitats_ab_rem)  #join new habitats and old habitats
#node_from
state_node_int_from<- int_edgelist_no_aggr %>% select(habitat,node_from,ab_node_from,
taxon_node_from) %>%
rename("node_id" ="node_from", "abundances" = "ab_node_from",
"taxon" = "taxon_node_from")%>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
#node_to
state_node_int_to<- int_edgelist_no_aggr %>% select(habitat,node_to,ab_node_to,
taxon_node_to) %>%
rename("node_id" ="node_to", "abundances" = "ab_node_to",
"taxon" = "taxon_node_to") %>%
group_by(habitat,node_id) %>% unique() #eliminate duplicate species within each habitat
state_node_int_agg<-rbind(state_node_int_from, state_node_int_to) %>% ungroup() %>%
select(-habitat) %>% group_by(node_id,taxon) %>%
mutate(abun = sum(abundances)) %>% distinct(abun) %>% group_by(taxon) %>%
mutate(tot_ab_taxon = sum(abun)) %>% #total abundance per taxon
group_by(node_id) %>%
mutate(rel_ab=abun/tot_ab_taxon)#rel abundance of species per taxon
int_edgelist_aggr<-int_edgelist_no_aggr %>% select(node_from,node_to) %>%
unique() %>%  #aggregated edge list
left_join(state_node_int_agg, by = c("node_from" = "node_id")) %>%  #incorporate rel abundances of node_from
left_join(state_node_int_agg, by = c("node_to" = "node_id")) %>%  #incorporate rel abundances of nodes_to
select(node_from,node_to, rel_ab.x,rel_ab.y) %>%
mutate(weight = rel_ab.x * rel_ab.y,management = "I") %>% #calculate weight
select(-rel_ab.x,-rel_ab.y)
land_change_weighted<-rbind(ext_edgelist_aggr,sem_ext_edgelist_aggr,mod_edgelist_aggr,
sem_int_edgelist_aggr,int_edgelist_aggr)
# final state_node list with abundances
state_nodes_weighted_ab<-rbind(ab_ext[,1:3],state_node_sem_ext_agg[,1:3],
state_node_mod_agg[,1:3],state_node_sem_int_agg[,1:3],
state_node_int_agg[,1:3])
species_new_habitats<-rbind(sp_WD_RG,sp_MH_NH,sp_GM_SF_PP,sp_LP_NL)
View(species_new_habitats)
# species lost in each habitat according to taxon
species_new_habitats<-rbind(sp_WD_RG,sp_MH_NH,sp_GM_SF_PP,sp_LP_NL) %>%
group_by(habitat) %>% mutate(total_sp_new = n())
View(species_new_habitats)
view(Norwood_farm$extended)
View(Norwood_farm)
View(Norwood_farm$state_nodes)
# species lost in each habitat after simulating land use change
species_new_habitats<-rbind(sp_WD_RG,sp_MH_NH,sp_GM_SF_PP,sp_LP_NL) %>%
group_by(habitat) %>% mutate(total_sp_new = n()) %>%  #final sp in each new habitat
total_sp_ori<-Norwood_farm$state_nodes %>% group_by(layer_name) %>%
mutate(total_sp_ori = n())
total_sp_ori<-Norwood_farm$state_nodes %>% group_by(layer_name) %>%
mutate(total_sp_ori = n())
View(total_sp_ori)
View(species_new_habitats)
species_new_habitats<-rbind(sp_WD_RG,sp_MH_NH,sp_GM_SF_PP,sp_LP_NL) %>%
group_by(habitat) %>%  mutate(total_sp_new = n()) %>%   #final sp in each new habitat and differences with the original
left_join(total_sp_ori[,c(3,5)], by = "layer_name" = "habitat")
species_new_habitats<-rbind(sp_WD_RG,sp_MH_NH,sp_GM_SF_PP,sp_LP_NL) %>%
group_by(habitat) %>%  mutate(total_sp_new = n()) %>%   #final sp in each new habitat and differences with the original
left_join(total_sp_ori[,c(3,5)], by = c("layer_name" = "habitat"))
species_new_habitats<-rbind(sp_WD_RG,sp_MH_NH,sp_GM_SF_PP,sp_LP_NL) %>%
group_by(habitat) %>%  mutate(total_sp_new = n()) %>%   #final sp in each new habitat and differences with the original
left_join(total_sp_ori[,c(3,5)], by = c("habitat" = "layer_name"))
View(species_new_habitats)
species_new_habitats<-rbind(sp_WD_RG,sp_MH_NH,sp_GM_SF_PP,sp_LP_NL) %>%
group_by(habitat) %>%  mutate(total_sp_new = n()) %>%
left_join(total_sp_ori[,c(3,5)], by = c("habitat" = "layer_name")) %>% #add information of number of species in the original habitat
mutate(diff_sp = total_sp_ori- total_sp_new) # Difference in the number of species between the original and the new
