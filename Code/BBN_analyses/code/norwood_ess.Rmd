---
title: "How habitat loss is effecting ecosystem service provisioning in Norwood farm"
author: "Anna Eklöf"
date: "01/07/2022"
output: 
  html_document:
    toc: true
    toc_depth: 3
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(tidyverse)
library(dplyr)
```

# Methods

### Modelling habitat loss 
In order to calculate how species are affected by loss of the various habitats we extract the fraction of all its links a taxon have in a specific habitat. These values are then directly used to increase the taxa probability of going extinct.  In other words, the taxon's background extinction risk ($\pi$) is increased. For now this is only done for plants.

### Analysing extinction probabilities using Bayesian Networks

%We connect the threats to the ecosystem service delivery via the food web of species interactions. This is possible since for all species in the food web we have identified i) the threats affecting them and ii) the ecosystem services they are providing. 

In order to analyze if threats towards specific species cause secondary extinctions of other species in the food web, we follow the Bayesian network approach outlined in \cite{Eklofetal2013MEE}. Modelling species interactions as Bayesian networks allow the species extinction probabilities to increase gradually with resource loss following some pre-defined function ($f$). Additionally, the species extinction probabilities can be nonzero even when species have full access to their resources -- all species have a baseline probability of extinction ($\pi$). This baseline probability quantifies the probability of species going extinct for causes other than those represented by the interaction network. Here we use this baseline probability of extinction to model how each species is affected by threats.

We model the probability $P(\neg C|f)$ of a species $C$ going extinct as a function of the fraction $f$ of its resources being absent:
\begin{equation}
  \label{eq:BN_prob}
  \tag{B1}
  P(\neg C|f) = \pi_C + (1 - \pi_C) B(f)
\end{equation}
where $\pi_C$ is species $C$'s baseline extinction probability, and $B(f)$ is a monotonically increasing function of $f$ such that $B(0)=0$ and $B(1)=1$. For any basal species $A$, $P(\neg A) = \pi_A$ is simply its baseline extinction probability. For a non-basal species $C$, one obtains $P(\neg C)$ by using $P(A) = 1-P(\neg A)$ and the law of total probability. For instance, if $C$ has two prey items $A$ and $B$, we write
\begin{equation}
  \label{eq:BN_marginal_example}
  \tag{B2}
  \begin{split}
    P(\neg C) &= P(\neg C|A B)P(A)P(B) + P(\neg C|\neg A B)P(\neg A)P(B)
    \\ &\quad + P(\neg C|A \neg B)P(A)P(\neg B) + P(\neg C|\neg A \neg B)
    P(\neg A)P(\neg B)
  \end{split}
\end{equation}
where $P(\neg C|A \neg B)$ is the probability of $C$ being extinct given that $A$ is extant and $B$ is extinct, and so on. Knowing $P(\neg A)$ and $P(\neg B)$ (either because they are basal species, or the same formula has been already used to derive their values), we can then calculate $P(\neg C)$ from Eq.~\ref{eq:BN_marginal_example}. Thus, determining the extinction probabilities of all species in a food web is a bottom-up calculation process: we start with basal species, then move on to species only consuming those basal species, and so on.

In the Bayesian network approach we can vary how sensitive consumers are to loss of resources by varying the functional form of a consumer's response to the loss of resources. Here we implement three different forms of the response function. All are described by a regularized beta function $B(f; a, b)$ of the fraction $f$ of resource species being lost, with different shape parameters $\alpha$ and $\beta$:
\begin{enumerate}
\item $a = 1, b = 1$. This is a linear function, meaning that the fraction of consumer species lost is linearly dependent on the fraction of resource species being lost.
\item $a = 2$, $b = 1$. This is a convex function, meaning that the probability of a consumer species being lost only start appreciably increasing after some fixed fraction of the resource species have already been lost.
\item $a = 1$, $ b = 2$. This is a concave function, meaning that the probability of a consumer species being lost attain high values already after the loss of a small fraction of its resource species.
\end{enumerate}

Due to the limited knowledge on the extent to which different species are affected by the different threats we analyzed three different levels of severity of the threats; low, medium and high. This corresponds to changing the baseline extinction probability ($\pi$) of the species affected by the threat to 0.1, 0.5 or 1.0 respectively, where the value 1.0 indicate that the species goes extinct when affected by the threat. 


### Calculating loss of ecosystem services
Ecosystem services are provided by single or, more often, several species. This means that the loss of ecosystem service provisioning depends on which and how many of the service providing species that are primarily and secondarily lost in the food web. We do the mapping of species losses to ecosystem service losses using the same method as for analysing how consumers react to loss of resources described above. We implement three different forms of the response function, which here describes how large fraction of the service providing species that can to be lost before the provisioning of different ecosystem services is affected. All response functions are described by a regularized beta function $B(f; \alpha, \beta)$ of the fraction $f$ of service providing species lost, with different shape parameters $\alpha$ and $\beta$:
\begin{enumerate}
\item $\alpha = \beta = 1$ (linear function). Here the fraction of the services being lost is linearly dependent on the fraction of service providing species being lost.
\item $\alpha=2$, $\beta=1$ (weak convex function). Here the fraction of the services being lost increases only after a fixed amount of the service providing species have been lost.
\item $\alpha=1$, $\beta=2$ (weak concave function). Here the fraction of the services being lost increases sharply already when a small fraction of the service providing species have been lost.
\end{enumerate}

We additionally ran more pronounced versions of the convex and concave functions (strong convex and strong concave with $\alpha=5$, $\beta=1$  and $\alpha=1$, $\beta=5$, respectively).

We calculate the average retention of a service, by extracting the extinction probabilities for all service providing species, and take the average over all values and then apply the beta functions described above. 

### Effects of species interactions
The mapping of threats to ecosystem service loss can be more or less affected by the species interactions in the networks. In cases where the species targeted by the threat are the same species providing the service, the effects of network structure will be unimportant. On the other hand, when species targeted by a specific threat differ from the ones providing the service in focus, species interactions are potentially important for the effects on ecosystem service provisioning. Therefore, we analyzed the overlap between threatened species and ecosystem service providing species. We calculate the number of species that are i) only affected by the threat, ii) only providing the ecosystem service, iii) are both targeted by the threat and provide the ecosystem service, and iv) are neither targeted by the threat nor an ecosystem service provider. 

Code for analyzing how loss of different habitat types on Norwood farm affect the ecosystem service delivery in the area. 

# Habitat loss
Here we extract the fraction of all links a taxon have in a specific habitat. These values are directly used to increase the taxa probability of going extinct. In other words, the taxon's background extinction risk ($\pi$) is increased. 

```{r, eval = FALSE}
# read in original file showing which interactions are found in which habitat
habitat_all <- tibble(read.csv("../../../Data/nore2_aggregated.csv"))

# clean the data
habitat_all <- habitat_all %>%
  separate(lower, c("lower_type"), remove = FALSE) %>%
  separate(upper, c("upper_type"), remove = FALSE) %>%
  unite("link_type",lower_type, upper_type, remove = FALSE) %>%
  relocate(link_type, .after = upper_type) %>% 
  select(-c(fortotals, round)) %>%
  filter(!(lower_type == upper_type)) %>% #
  filter(!(upper_type == "01PLANT")) %>% # filter away entities where plants are not the lowest level 
  distinct() 


# combine lower and upper so all in a new column taxon
habitat_lower <- habitat_all %>% # separate lower and upper
  select(lower, lower_type, link_type, habitat)  %>%
  rename(taxon = lower, taxa_type = lower_type) %>%
  mutate(link_direction = "lower")
  # now each taxon 

habitat_upper <- habitat_all %>%
  select(upper, upper_type, link_type, habitat) %>%
  rename(taxon = upper, taxa_type = upper_type) %>%
  mutate(link_direction = "higher")

habitat_lower_upper <- union_all(habitat_lower, habitat_upper) 
# each species in each habitat has its own row and taxa_type, link_type and link_direction are included.

# get the fraction of a species total number of interactions that take place in each habitat
habitat_fracs <- habitat_lower_upper%>%
  group_by(taxon, habitat, link_direction, taxa_type) %>%   # OR count(lower, habitat) %>% 
  tally() %>%
  ungroup() %>%
  rename(int_per_hab = n) %>%
  group_by(taxon) %>%
  mutate(tot_interactions = sum(int_per_hab)) %>%
  ungroup() %>%
  mutate(frac_per_hab = int_per_hab / tot_interactions) %>%
  select(-c(int_per_hab, tot_interactions)) %>%
# frac_per_hab shows the fraction of all its links a taxon have in a specific habitat
# now make a data frame with habitats in one column each 
  pivot_wider(names_from = habitat, values_from = frac_per_hab, values_fill = 0)
  #select only the plants
  #filter(taxa_type == "01PLANT")

write.csv(habitat_fracs, file =  "../new_data_files/norwood_therats_plants.csv")  
```  


# Parameter values
Here one can change the parameter values if code should be executed

```{r}
alpha <- 1 # alpha and beta determines how a consumer respond to loss of resources (1,1) means a linear response.
beta <- 1
nreps <- 1000 # Number of iterations, set to 10.000 for real runs
webname <- "norwood"
```

# Load data files 
1. edges: edge list with resources in the first column and consumers in the second column. 
2. threats: data frame with species (taxon) in the first column and habitats in the other columns. The entities indicate how much the extinction probability should increase for each species when a certain habitat is lost. Habitats is thereby the "threats". The values are based on the fraction of interactions a species has in each habitat. 
3. services: data frame with species (taxon) in the first column and services in the other columns. Binary data where a 1 indicates the taxon directly provides that service 
4. sp_info: dataframe with taxon in the first column, information on the species in the other columns. For now only species type is included. 

 Data is updated data files, on GitHub 22-06-29. 

```{r}
 edges <- tibble(read.csv("../../../Data/species_edgelist.csv"))  %>%
   select(lower, upper) %>%
   rename(resource = lower, consumer = upper)
 
 threats <- tibble(read.csv("../new_data_files/norwood_therats_plants.csv")) # constructed in habitat_loss.R
 
 services <- tibble(read.csv("../../../Data/service_edgelist.csv")) %>%
   rename (taxon = lower, ESS = upper) %>%
   pivot_wider(names_from = ESS, values_from = weight, values_fill = 0) %>%
   mutate(taxa_type = str_split(taxon, pattern = "[.]")[[2]][1]) 
```

# Threat analyses - code

```{r, eval = FALSE}
source("threat_functions_Norwood.R", local = knitr::knit_global()) # functions for analyzing how different threats affect persistence of different species 
persistence <- threat_analysis(edges, threats, alpha, beta, nreps, webname) # used in get_ESS.R 
# ´persistence´gives the likelihoods for being extant for all species depending on threat (here habitat loss) realized 
write_rds(persistence, "../results/persistence_norwood.rds", compress = "xz")
```

# ESS analyses - code
Functions for analyzing the how changes in species persistence affect ecosystem services. How a service is affected depends on how  
```{r, eval = FALSE}
#source("get_ESS_norwood.R", local = knitr::knit_global())  # functions for analyzing the how changes in species persistence affect ecosystem services 

```

# Read in the result files 
If code in earlier sections not been evaluated we instead load result files. 
'persistence' contains the likelihoods for being extant for all species depending on threat (here habitat loss) realized 
'ESS' contains the total service retained after effects of threats (here habitat losses) been realized. 

```{r, include= TRUE} 
persistence <- readRDS("../results/persistence_norwood.rds")
ESS <- read_rds("../results/norwood_ESS_changes.rds")
```

# Plotting results
Plot with the habitatmlost on the x-axis and fraction of service retained on the y-axis. 

```{r}
 
 ESS %>% 
  filter(ESS_alpha==1, ESS_beta ==1) %>%
   filter(!threat == "all") %>%
 ggplot(aes(x = threat, y = service_total)) +
   geom_boxplot() +
      geom_point(position=position_jitterdodge(jitter.width=2, dodge.width = 0.5), 
             pch=21, aes(fill=factor(ESS)), size = 3, show.legend = T) +
   # scale_fill_manual(values = col) + 
   scale_fill_brewer(palette="PRGn") +
   scale_y_continuous(name = "Fraction of service retained", limits = c(0.2, 1)) + 
     scale_x_discrete(name = "Habitat lost")
```

Plot for which species have which role in the network. With role means here if the species is 1) only directly affected by the threat, 2) only directly providing an ESS, 3) is both directly affected by the threat and directly provides ESS, or 4) is neither affected by the threat or directly provides ESS.

```{r}

plot_overlap_roles <- function(sp_def, threats, ess) {
  new <- NULL
  for(t in threat){
    for(e in ess){
      sp_overlap <- sp_def %>%
        select(taxon, t, e) %>%
        mutate_if(is.numeric, ~1 * (. != 0)) %>%
        mutate(ess = e, threat = t) %>%
        unite("overlap", t:e, sep = "_") %>%
        mutate(overlap = case_when(overlap == '1_0' ~ 'threatened',
                                   overlap == '0_1' ~ 'ESS provider',
                                   overlap == '1_1' ~ 'both',
                                   overlap == '0_0' ~ 'none'))
      
      new <- rbind(sp_overlap, new)
    }
  }
  level_order <- ess
  OL<- new %>%
    ggplot(aes(x = factor(ess, level = level_order), fill = overlap)) + 
    geom_bar() +
   scale_fill_brewer(palette = "RdBu", direction = -1) +
   # scale_fill_viridis_d(alpha = 0.8) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10),
          legend.title = element_text(size=10),
          legend.text = element_text(size=10)) +
    theme(strip.text = element_text(colour = 'black', size=10)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(x="Ecosystem service", y="Number of species", size = 15) +
    facet_wrap(~ threat, nrow = 2) %>%
    return(OL)
  
}

# needed for general properties
#threats<-  tibble(read.csv("../new_data_files/norwood_therats_plants.csv")) # needed for counting species threatened/ESS providers
threatlist <- threats %>%
  select(!X)
ESSlist <- services

sp_def <- ESSlist %>%
    left_join(threatlist, by = "taxon")
  
a <- 1
b <- 1
a_ess <- 1
b_ess <- 1

ess <- names(ESSlist[2:8])
threat <- names(threatlist[4:18])
  
fname <- paste0("../figures/ESS_changes/species_roles_overlap-",
                a, "-", b, "-ESSsum-", a_ess, "-", b_ess,".pdf")
overlap_roles <- plot_overlap_roles(sp_def, threats, ess) # Create figure
```
```{r fig2, fig.height = 8, fig.width = 12}
plot(overlap_roles)
```

   


